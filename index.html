<!DOCTYPE html>
<html lang="ta">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <meta name="description" content="One Year Bible тАФ New Jerusalem Church">
  <title>роТро░рпБ ро╡ро░рпБроЯ рокрпИрокро┐ро│рпН тАФ NJC</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Tamil:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root {
      --bg: #f8f9fa;
      --text: #212529;
      --text-secondary: #495057;
      --accent: #2c5a8c;
      --card: #ffffff;
      --border: #e0e0e0;
      --success: #28a745;
      --shadow: 0 3px 10px rgba(0,0,0,0.08);
    }
    .dark-mode {
      --bg: #121212;
      --text: #e0e0e0;
      --text-secondary: #b0b0b0;
      --card: #1e1e1e;
      --border: #333;
      --accent: #4da6ff;
      --success: #4caf50;
      --shadow: 0 3px 12px rgba(0,0,0,0.25);
    }
    .dark-mode .ref-ta {
      color: #d0d0d0;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background-color: var(--bg);
      color: var(--text);
      line-height: 1.5;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .watermark {
      position: fixed;
      bottom: 10px;
      right: 10px;
      opacity: 0.05;
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--text);
      pointer-events: none;
      z-index: -1;
      transform: rotate(-30deg);
    }
    .title-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: var(--card);
      box-shadow: 0 1px 6px rgba(0,0,0,0.1);
      z-index: 10;
    }
    .title-bar h1 {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--accent);
      text-align: center;
      flex: 1;
      margin: 0 12px;
    }
    .nav-btn {
      background: none;
      border: none;
      color: var(--accent);
      font-size: 1.25rem;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }
    .tabs {
      display: flex;
      background: var(--card);
      border-bottom: 1px solid var(--border);
    }
    .tab-btn {
      flex: 1;
      padding: 12px 0;
      background: none;
      border: none;
      font-size: 0.95rem;
      font-weight: 600;
      color: #6c757d;
      cursor: pointer;
    }
    .tab-btn.active {
      color: var(--accent);
      border-bottom: 2px solid var(--accent);
    }
    .dark-mode .tab-btn { color: #aaa; }
    .dark-mode .tab-btn.active { color: var(--accent); }
    .content {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 16px;
      gap: 16px;
      overflow: hidden;
    }
    #today-view {
      display: flex;
      flex-direction: column;
      gap: 16px;
      height: 100%;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 18px;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    #date-card {
      padding: 16px;
    }
    #date-card .date-text {
      font-size: 1.15rem;
      font-weight: 600;
      color: var(--accent);
    }
    .section-title {
      font-size: 1.15rem;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    .verse-item {
      margin: 6px 0;
      cursor: pointer;
      padding: 4px;
      border-radius: 6px;
      transition: background 0.2s;
    }
    .verse-item:hover {
      background: rgba(44, 90, 140, 0.05);
    }
    .dark-mode .verse-item:hover {
      background: rgba(77, 166, 255, 0.1);
    }
    .ref-en {
      font-weight: 600;
      font-size: 1.1rem;
      color: var(--text);
    }
    .ref-ta {
      font-size: 1.1rem;
      color: var(--text-secondary);
      font-family: "Noto Sans Tamil", "Latha", sans-serif;
      margin-top: 4px;
    }
    #calendar-view,
    #bible-view {
      display: none;
      flex: 1;
      overflow-y: auto;
      padding: 0 8px;
      position: relative;
    }
    .selector-row {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    .selector-row select {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--card);
      color: var(--text);
      font-size: 0.95rem;
    }
    #bible-search {
      width: 100%;
      padding: 8px;
      margin: 8px 0;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--card);
      color: var(--text);
      font-size: 0.95rem;
      display: block;
    }
    .verse-display {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      box-shadow: var(--shadow);
      font-family: "Noto Sans Tamil", "Latha", sans-serif;
      font-size: 1.1rem;
      line-height: 1.6;
      text-align: left;
    }
    .verse-display .verse-num {
      color: var(--accent);
      font-weight: bold;
      margin-right: 6px;
    }
    .bottom-bar {
      display: flex;
      justify-content: space-around;
      padding: 10px 0;
      background: var(--card);
      border-top: 1px solid var(--border);
    }
    .bottom-bar button {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      background: var(--accent);
      color: white;
      border: none;
      width: 48%;
      padding: 10px;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
    }
    .bottom-bar .share-btn { background: var(--success); }
    .bottom-bar button i { font-size: 1.1rem; }

    /* === TEMPORARY NAV BUTTONS (APPEAR ON TAP) === */
    #bible-nav-buttons {
      display: flex;
      position: sticky;
      bottom: 10px;
      left: 0;
      right: 0;
      z-index: 5;
      justify-content: center;
      gap: 16px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    #bible-nav-buttons.visible {
      opacity: 1;
      pointer-events: auto;
    }
    #bible-nav-buttons button {
      padding: 10px 20px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 24px;
      font-weight: 600;
      font-size: 0.95rem;
      min-width: 80px;
    }
  </style>
</head>
<body>
  <div class="title-bar">
    <button class="nav-btn" onclick="goToDay(-1)" aria-label="Previous">
      <i class="fas fa-chevron-left"></i>
    </button>
    <h1>One Year Bible</h1>
    <button class="nav-btn" id="today-btn" onclick="goToToday()" style="display:none;" aria-label="Go to today">
      <i class="fas fa-home"></i>
    </button>
    <button class="nav-btn" onclick="toggleTheme()" aria-label="Toggle theme" id="theme-toggle">
      <i class="fas fa-moon"></i>
    </button>
  </div>
  <div class="tabs">
    <button class="tab-btn active" onclick="showTab('today')">Today</button>
    <button class="tab-btn" onclick="showTab('calendar')">Calendar</button>
    <button class="tab-btn" onclick="showTab('bible')">Bible</button>
  </div>
  <div class="content">
    <div id="today-view">
      <div class="card" id="date-card">
        <div class="date-text" id="today-date"></div>
      </div>
      <div class="card">
        <div class="section-title"><i class="fas fa-sun"></i> Morning</div>
        <div id="morning-list"></div>
      </div>
      <div class="card">
        <div class="section-title"><i class="fas fa-moon"></i> Evening</div>
        <div id="evening-list"></div>
      </div>
    </div>
    <div id="calendar-view"></div>
    <div id="bible-view">
      <div class="selector-row">
        <select id="book-select" lang="ta" onchange="loadChapters()" disabled><option>рокрпБродрпНродроХроорпН родрпЗро░рпНро╡рпБ роЪрпЖропрпНропрокрпНрокроЯро╡ро┐ро▓рпНро▓рпИ</option></select>
        <select id="chapter-select" lang="ta" onchange="loadVerses()" disabled><option>роЕродро┐роХро╛ро░роорпН родрпЗро░рпНро╡рпБ роЪрпЖропрпНропрокрпНрокроЯро╡ро┐ро▓рпНро▓рпИ</option></select>
      </div>
      <input type="text" id="bible-search" placeholder="Search entire Bible..." oninput="searchWholeBible(this.value)">
      <div class="verse-display" id="verse-display" onclick="showNavTemporarily()">
        рокрпИрокро┐ро│рпН роПро▒рпНро▒рокрпНрокроЯрпБроХро┐ро▒родрпБ...
      </div>
      <div id="bible-nav-buttons">
        <button id="prev-chap-btn" onclick="navigateChapter(-1)">тЖР Prev</button>
        <button id="next-chap-btn" onclick="navigateChapter(1)">Next тЖТ</button>
      </div>
    </div>
  </div>
  <div class="bottom-bar">
    <button class="progress-btn" onclick="markAsRead()">
      <i class="fas fa-check-circle"></i> Mark Read
    </button>
    <button class="share-btn" onclick="shareReadings()">
      <i class="fas fa-share-alt"></i> Share
    </button>
  </div>
  <div class="watermark">JayathaSoft</div>

  <script>
    // === LOAD EXTERNAL FILES ===
    let TAMIL_BIBLE = null;
    let READING_PLAN_EN = [];
    let READING_PLAN_TA = [];
    const TAMIL_BOOK_NAMES = [
      "роЖродро┐ропро╛роХроороорпН", "ропро╛родрпНродро┐ро░ро╛роХроороорпН", "ро▓рпЗро╡ро┐ропро░ро╛роХроороорпН", "роОрогрпНрогро╛роХроороорпН", "роЙрокро╛роХроороорпН", "ропрпЛроЪрпБро╡ро╛", "роиро┐ропро╛ропро╛родро┐рокродро┐роХро│рпН", "ро░рпВродрпН", "1 роЪро╛роорпБро╡рпЗро▓рпН",
      "2 роЪро╛роорпБро╡рпЗро▓рпН", "1 роЗро░ро╛роЬро╛роХрпНроХро│рпН", "2 роЗро░ро╛роЬро╛роХрпНроХро│рпН", "1 роиро╛ро│ро╛роХроороорпН", "2 роиро╛ро│ро╛роХроороорпН", "роОро╕рпНро▒ро╛", "роирпЖроХрпЗрооро┐ропро╛", "роОро╕рпНродро░рпН", "ропрпЛрокрпБ",
      "роЪроЩрпНроХрпАродроорпН", "роирпАродро┐роорпКро┤ро┐роХро│рпН", "рокро┐ро░роЪроЩрпНроХро┐", "роЙройрпНройродрокрпНрокро╛роЯрпНроЯрпБ", "роПроЪро╛ропро╛", "роОро░рпЗрооро┐ропро╛", "рокрпБро▓роорпНрокро▓рпН", "роОроЪрпЗроХрпНроХро┐ропрпЗро▓рпН", "родро╛ройро┐ропрпЗро▓рпН", "роУроЪро┐ропро╛",
      "ропрпЛро╡рпЗро▓рпН", "роЖроорпЛро╕рпН", "роТрокродро┐ропро╛", "ропрпЛройро╛", "роорпАроХро╛", "роиро╛роХрпВроорпН", "роЖрокроХрпВроХрпН", "роЪрпЖрокрпНрокройро┐ропро╛", "роЖроХро╛ропрпН", "роЪроХро░ро┐ропро╛", "рооро▓рпНроХро┐ропро╛",
      "роородрпНродрпЗропрпБ", "рооро╛ро▒рпНроХрпБ", "ро▓рпВроХрпНроХро╛", "ропрпЛро╡ро╛ройрпН", "роЕрокрпНрокрпЛро╕рпНродро▓ро░рпН", "ро░рпЛрооро░рпН", "1 роХрпКро░ро┐роирпНродро┐ропро░рпН", "2 роХрпКро░ро┐роирпНродро┐ропро░рпН", "роХро▓ро╛родрпНродро┐ропро░рпН",
      "роОрокрпЗроЪро┐ропро░рпН", "рокро┐ро▓ро┐рокрпНрокро┐ропро░рпН", "роХрпКро▓рпЛроЪрпЖропро░рпН", "1 родрпЖроЪро▓рпЛройро┐роХрпНроХрпЗропро░рпН", "2 родрпЖроЪро▓рпЛройро┐роХрпНроХрпЗропро░рпН", "1 родрпАроорпЛродрпНродрпЗропрпБ", "2 родрпАроорпЛродрпНродрпЗропрпБ", "родрпАродрпНродрпБ",
      "рокро┐ро▓рпЗроорпЛройрпН", "роОрокро┐ро░рпЖропро░рпН", "ропро╛роХрпНроХрпЛрокрпБ", "1 рокрпЗродрпБро░рпБ", "2 рокрпЗродрпБро░рпБ", "1 ропрпЛро╡ро╛ройрпН", "2 ропрпЛро╡ро╛ройрпН", "3 ропрпЛро╡ро╛ройрпН", "ропрпВродро╛", "ро╡рпЖро│ро┐"
    ];

    // === HELPER: Get UTC-based day of year ===
    function getUTCDayOfYear(date) {
      const year = date.getUTCFullYear();
      const start = Date.UTC(year, 0, 1);
      const today = Date.UTC(year, date.getUTCMonth(), date.getUTCDate());
      return Math.floor((today - start) / 86400000);
    }

    // === PARSE REFERENCE (e.g., "Gen 1:1-5" or "Psalm 23") ===
    function parseReference(ref) {
      const enBookNames = [
        "Genesis", "Exodus", "Leviticus", "Numbers", "Deuteronomy", "Joshua", "Judges", "Ruth", "1 Samuel",
        "2 Samuel", "1 Kings", "2 Kings", "1 Chronicles", "2 Chronicles", "Ezra", "Nehemiah", "Esther", "Job",
        "Psalms", "Proverbs", "Ecclesiastes", "Song of Solomon", "Isaiah", "Jeremiah", "Lamentations", "Ezekiel", "Daniel", "Hosea",
        "Joel", "Amos", "Obadiah", "Jonah", "Micah", "Nahum", "Habakkuk", "Zephaniah", "Haggai", "Zechariah", "Malachi",
        "Matthew", "Mark", "Luke", "John", "Acts", "Romans", "1 Corinthians", "2 Corinthians", "Galatians",
        "Ephesians", "Philippians", "Colossians", "1 Thessalonians", "2 Thessalonians", "1 Timothy", "2 Timothy", "Titus",
        "Philemon", "Hebrews", "James", "1 Peter", "2 Peter", "1 John", "2 John", "3 John", "Jude", "Revelation"
      ];
      for (let i = 0; i < enBookNames.length; i++) {
        if (ref.startsWith(enBookNames[i])) {
          const rest = ref.slice(enBookNames[i].length).trim();
          const chapterMatch = rest.match(/^(\d+)/);
          const chapter = chapterMatch ? parseInt(chapterMatch[1], 10) : 1;
          return { bookIndex: i, chapter: chapter };
        }
      }
      return null;
    }

    // === JUMP TO VERSE (from reading plan or search) ===
    function jumpToBible(bookIndex, chapter) {
      if (!TAMIL_BIBLE) return;
      document.getElementById('book-select').value = bookIndex;
      loadChapters();
      const chapterSelect = document.getElementById('chapter-select');
      const chapIndex = chapter - 1;
      if (chapIndex >= 0 && chapIndex < TAMIL_BIBLE.books[bookIndex].chapters.length) {
        chapterSelect.value = chapIndex;
        loadVerses();
      }
      showTab('bible');
    }

    async function loadAppData() {
      try {
        const bibleRes = await fetch('bibles/tamilbible.json');
        if (!bibleRes.ok) throw new Error('tamilbible.json not found');
        const bibleData = await bibleRes.json();
        TAMIL_BIBLE = {
          books: bibleData.Book.map((bookObj, index) => {
            const name = TAMIL_BOOK_NAMES[index] || `рокрпБродрпНродроХроорпН ${index + 1}`;
            const chapters = bookObj.Chapter ? bookObj.Chapter.map(ch =>
              ch.Verse ? ch.Verse.map(v => v.Verse || '') : []
            ) : [];
            return { name, chapters };
          })
        };
        document.getElementById('book-select').disabled = false;
        populateBooks();

        const planRes = await fetch('plan/njcplan.json');
        if (!planRes.ok) throw new Error('njcplan.json not found');
        const planData = await planRes.json();
        READING_PLAN_EN = planData.readingPlan;
        const TAMIL_MAP = planData.tamilMap;

        function convertToTamil(ref) {
          const books = Object.keys(TAMIL_MAP).sort((a, b) => b.length - a.length);
          for (const book of books) {
            if (ref.startsWith(book)) {
              return TAMIL_MAP[book] + ref.slice(book.length);
            }
          }
          return ref;
        }

        READING_PLAN_TA = READING_PLAN_EN.map(day => ({
          morning: day.morning.map(convertToTamil),
          evening: day.evening.map(convertToTamil)
        }));

        goToToday(); // Use corrected UTC logic
        document.getElementById('verse-display').innerHTML = 'рокрпБродрпНродроХродрпНродрпИродрпН родрпЗро░рпНроирпНродрпЖроЯрпБроХрпНроХро╡рпБроорпН.';
      } catch (err) {
        console.error('App load error:', err);
        document.getElementById('verse-display').innerHTML = 'родро╡ро▒рпБ: ' + err.message;
      }
    }

    // === BIBLE UI FUNCTIONS ===
    function populateBooks() {
      const select = document.getElementById('book-select');
      select.innerHTML = '';
      TAMIL_BIBLE.books.forEach((book, index) => {
        const opt = document.createElement('option');
        opt.value = index;
        opt.textContent = book.name;
        select.appendChild(opt);
      });
      loadChapters();
    }
    function loadChapters() {
      const bookIndex = document.getElementById('book-select').value;
      const chapterSelect = document.getElementById('chapter-select');
      chapterSelect.innerHTML = '';
      if (bookIndex === '') return;
      const book = TAMIL_BIBLE.books[bookIndex];
      for (let i = 1; i <= book.chapters.length; i++) {
        const opt = document.createElement('option');
        opt.value = i - 1;
        opt.textContent = i;
        chapterSelect.appendChild(opt);
      }
      chapterSelect.disabled = false;
      loadVerses();
    }
    function loadVerses() {
      const bookIndex = document.getElementById('book-select').value;
      const chapterIndex = document.getElementById('chapter-select').value;
      const display = document.getElementById('verse-display');
      if (bookIndex === '' || chapterIndex === '') {
        display.innerHTML = 'роЕродро┐роХро╛ро░родрпНродрпИродрпН родрпЗро░рпНроирпНродрпЖроЯрпБроХрпНроХро╡рпБроорпН.';
        return;
      }
      const chapter = TAMIL_BIBLE.books[bookIndex].chapters[chapterIndex];
      let html = '';
      chapter.forEach((verseText, verseIndex) => {
        const verseNum = verseIndex + 1;
        html += `<p><span class="verse-num">${verseNum}</span>${verseText}</p>`;
      });
      display.innerHTML = html || 'ро╡роЪройроЩрпНроХро│рпН роХро┐роЯрпИроХрпНроХро╡ро┐ро▓рпНро▓рпИ.';
    }
    function searchWholeBible(query) {
      query = query.trim().toLowerCase();
      const display = document.getElementById('verse-display');
      if (!TAMIL_BIBLE || !query) {
        loadVerses();
        return;
      }
      let results = [];
      TAMIL_BIBLE.books.forEach((book, bookIndex) => {
        book.chapters.forEach((chapter, chapIndex) => {
          chapter.forEach((verseText, verseIndex) => {
            if (verseText.toLowerCase().includes(query)) {
              results.push({
                bookIndex,
                chapter: chapIndex + 1,
                verseNum: verseIndex + 1,
                text: verseText,
                bookName: book.name
              });
            }
          });
        });
      });
      if (results.length === 0) {
        display.innerHTML = '<p style="text-align:center; color:var(--text-secondary);">родрпЗроЯро▓рпН роорпБроЯро┐ро╡рпБроХро│рпН роЗро▓рпНро▓рпИ.</p>';
      } else {
        let html = `<p style="margin-bottom:12px;"><strong>${results.length} роорпБроЯро┐ро╡рпБроХро│рпН роХро┐роЯрпИродрпНродрой:</strong></p>`;
        results.forEach(r => {
          html += `<p onclick="jumpToBible(${r.bookIndex}, ${r.chapter})" style="cursor:pointer; padding:6px; border-radius:6px;">
            <strong>${r.bookName} ${r.chapter}:${r.verseNum}</strong><br>${r.text}
          </p>`;
        });
        display.innerHTML = html;
      }
    }
    function navigateChapter(direction) {
      const bookSelect = document.getElementById('book-select');
      const chapterSelect = document.getElementById('chapter-select');
      const bookIndex = parseInt(bookSelect.value);
      const chapterIndex = parseInt(chapterSelect.value);
      if (isNaN(bookIndex) || isNaN(chapterIndex)) return;
      const totalChapters = TAMIL_BIBLE.books[bookIndex].chapters.length;
      let newChapterIndex = chapterIndex + direction;
      if (newChapterIndex < 0) {
        let newBookIndex = bookIndex - 1;
        if (newBookIndex < 0) return;
        bookSelect.value = newBookIndex;
        loadChapters();
        const newTotal = TAMIL_BIBLE.books[newBookIndex].chapters.length;
        chapterSelect.value = newTotal - 1;
      } else if (newChapterIndex >= totalChapters) {
        let newBookIndex = bookIndex + 1;
        if (newBookIndex >= TAMIL_BIBLE.books.length) return;
        bookSelect.value = newBookIndex;
        loadChapters();
        chapterSelect.value = 0;
      } else {
        chapterSelect.value = newChapterIndex;
      }
      loadVerses();
    }

    // === TEMPORARY NAV BUTTONS ===
    let navTimeout;
    function showNavTemporarily() {
      const nav = document.getElementById('bible-nav-buttons');
      nav.classList.add('visible');
      clearTimeout(navTimeout);
      navTimeout = setTimeout(() => {
        nav.classList.remove('visible');
      }, 3000);
    }

    // === APP CORE ===
    let currentDayIndex = null;
    let currentView = 'today';
    function isDarkMode() {
      return document.body.classList.contains('dark-mode');
    }
    function setTheme(dark) {
      if (dark) {
        document.body.classList.add('dark-mode');
        localStorage.setItem('theme', 'dark');
        document.getElementById('theme-toggle').innerHTML = '<i class="fas fa-sun"></i>';
      } else {
        document.body.classList.remove('dark-mode');
        localStorage.setItem('theme', 'light');
        document.getElementById('theme-toggle').innerHTML = '<i class="fas fa-moon"></i>';
      }
    }
    function toggleTheme() {
      setTheme(!isDarkMode());
    }
    function applySavedTheme() {
      const saved = localStorage.getItem('theme');
      if (saved === 'dark') {
        setTheme(true);
      } else if (saved === 'light') {
        setTheme(false);
      } else {
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
          setTheme(true);
        } else {
          setTheme(false);
        }
      }
    }
    function loadProgress() {
      const saved = localStorage.getItem('bibleProgress');
      return saved ? JSON.parse(saved) : {};
    }
    function saveProgress(progress) {
      localStorage.setItem('bibleProgress', JSON.stringify(progress));
    }
    function renderReadings(dayIndex) {
      if (dayIndex < 0 || dayIndex >= READING_PLAN_EN.length) return;
      const now = new Date();
      const year = now.getFullYear();
      const targetDate = new Date(year, 0, 1);
      targetDate.setDate(targetDate.getDate() + dayIndex);
      document.getElementById('today-date').textContent = targetDate.toLocaleDateString('en-US', {
        weekday: 'short', month: 'short', day: 'numeric'
      });
      const en = READING_PLAN_EN[dayIndex];
      const ta = READING_PLAN_TA[dayIndex];
      const render = (id, enRefs, taRefs) => {
        document.getElementById(id).innerHTML = enRefs.map((enRef, i) => {
          const taRef = taRefs[i] || enRef;
          const parsed = parseReference(enRef);
          const clickAttr = parsed ? `onclick="jumpToBible(${parsed.bookIndex}, ${parsed.chapter})"` : '';
          return `<div class="verse-item" ${clickAttr}>
            <div class="ref-en">${enRef}</div>
            <div class="ref-ta">${taRef}</div>
          </div>`;
        }).join('');
      };
      render('morning-list', en.morning, ta.morning);
      render('evening-list', en.evening, ta.evening);
      currentDayIndex = dayIndex;
      const todayDayIndex = getUTCDayOfYear(new Date());
      const isToday = (dayIndex === todayDayIndex);
      const todayBtn = document.getElementById('today-btn');
      if (isToday) {
        todayBtn.style.display = 'none';
      } else {
        todayBtn.style.display = 'flex';
      }
    }
    function goToDay(offset) {
      const todayDayIndex = getUTCDayOfYear(new Date());
      let target = offset === 0 ? todayDayIndex : (currentDayIndex !== null ? currentDayIndex + offset : todayDayIndex + offset);
      target = Math.max(0, Math.min(READING_PLAN_EN.length - 1, target));
      renderReadings(target);
      if (currentView !== 'today') showTab('today');
    }
    function goToToday() {
      const todayDayIndex = getUTCDayOfYear(new Date());
      renderReadings(Math.min(READING_PLAN_EN.length - 1, todayDayIndex));
      if (currentView !== 'today') showTab('today');
    }
    function markAsRead() {
      if (currentDayIndex === null) return;
      const progress = loadProgress();
      progress[currentDayIndex] = true;
      saveProgress(progress);
      const btn = document.querySelector('.progress-btn');
      const original = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-check"></i> Done';
      setTimeout(() => { btn.innerHTML = original; }, 1000);
    }
    function showTab(view) {
      currentView = view;
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      const todayView = document.getElementById('today-view');
      const calendarView = document.getElementById('calendar-view');
      const bibleView = document.getElementById('bible-view');
      if (view === 'today') {
        document.querySelectorAll('.tab-btn')[0].classList.add('active');
        todayView.style.display = 'flex';
        calendarView.style.display = 'none';
        bibleView.style.display = 'none';
      } else if (view === 'calendar') {
        document.querySelectorAll('.tab-btn')[1].classList.add('active');
        todayView.style.display = 'none';
        renderFullCalendar();
        calendarView.style.display = 'block';
        bibleView.style.display = 'none';
      } else if (view === 'bible') {
        document.querySelectorAll('.tab-btn')[2].classList.add('active');
        todayView.style.display = 'none';
        calendarView.style.display = 'none';
        bibleView.style.display = 'block';
      }
    }
    function renderFullCalendar() {
      const container = document.getElementById('calendar-view');
      container.innerHTML = '';
      const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      const progress = loadProgress();
      const now = new Date();
      const year = now.getFullYear();
      const todayDayIndex = getUTCDayOfYear(now);
      for (let month = 0; month < 12; month++) {
        const monthDiv = document.createElement('div');
        monthDiv.style.marginBottom = '16px';
        const monthHeader = document.createElement('div');
        monthHeader.textContent = months[month];
        monthHeader.style.color = 'var(--accent)';
        monthHeader.style.fontSize = '0.95rem';
        monthHeader.style.marginBottom = '8px';
        monthDiv.appendChild(monthHeader);
        const grid = document.createElement('div');
        grid.style.display = 'grid';
        grid.style.gridTemplateColumns = 'repeat(7, 1fr)';
        grid.style.gap = '2px';
        grid.style.fontSize = '0.75rem';
        const firstDay = new Date(year, month, 1);
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const startDay = firstDay.getDay();
        const prevMonthDays = new Date(year, month, 0).getDate();
        for (let i = startDay - 1; i >= 0; i--) {
          const dayEl = document.createElement('div');
          dayEl.textContent = prevMonthDays - i;
          dayEl.style.color = '#888';
          dayEl.style.opacity = '0.4';
          dayEl.style.textAlign = 'center';
          grid.appendChild(dayEl);
        }
        const isCurrentYear = (now.getFullYear() === year);
        const isCurrentMonth = (isCurrentYear && now.getMonth() === month);
        const todayDate = now.getDate();
        for (let day = 1; day <= daysInMonth; day++) {
          const date = new Date(year, month, day);
          const dayOfYear = getUTCDayOfYear(date);
          const isToday = isCurrentMonth && day === todayDate && dayOfYear === todayDayIndex;
          const isCompleted = progress[dayOfYear] === true;
          const isFuture = dayOfYear >= READING_PLAN_EN.length;
          const dayEl = document.createElement('div');
          dayEl.textContent = day;
          dayEl.style.textAlign = 'center';
          dayEl.style.padding = '4px 0';
          dayEl.style.borderRadius = '4px';
          if (isFuture) {
            dayEl.style.color = '#888';
            dayEl.style.opacity = '0.4';
          } else {
            if (isCompleted) {
              dayEl.style.background = 'var(--success)';
              dayEl.style.color = 'white';
            }
            if (isToday && !isCompleted) {
              dayEl.style.background = 'var(--accent)';
              dayEl.style.color = 'white';
            }
            if (!isCompleted && !isToday) {
              dayEl.style.cursor = 'pointer';
              dayEl.onclick = () => {
                renderReadings(dayOfYear);
                showTab('today');
              };
            }
          }
          grid.appendChild(dayEl);
        }
        const totalCells = grid.children.length;
        const remaining = 42 - totalCells;
        for (let i = 1; i <= remaining; i++) {
          const dayEl = document.createElement('div');
          dayEl.textContent = i;
          dayEl.style.color = '#888';
          dayEl.style.opacity = '0.4';
          dayEl.style.textAlign = 'center';
          grid.appendChild(dayEl);
        }
        monthDiv.appendChild(grid);
        container.appendChild(monthDiv);
      }
    }
    async function shareReadingsAsImage() {
      if (currentDayIndex === null) return;
      if (!window.html2canvas) {
        await new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = 'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
          script.onload = resolve;
          script.onerror = reject;
          document.head.appendChild(script);
        });
      }
      const en = READING_PLAN_EN[currentDayIndex];
      const ta = READING_PLAN_TA[currentDayIndex];
      const dateStr = document.getElementById('today-date').textContent;
      const card = document.createElement('div');
      card.style.cssText = `
        position: fixed;
        left: -9999px;
        top: -9999px;
        width: 320px;
        background: white;
        padding: 20px;
        border-radius: 12px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        color: #222;
        line-height: 1.4;
        border: 1px solid #e0e0e0;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      `;
      card.innerHTML = `
        <div style="text-align:center; margin-bottom:12px; color:#2c5a8c; font-weight:600;">
          <i class="fas fa-book-open"></i> One Year Bible<br>
          <span style="font-size:0.9rem; color:#555;">${dateStr}</span>
        </div>
        <div style="margin-bottom:14px;">
          <div style="font-weight:600; margin-bottom:6px; color:#2c5a8c;"><i class="fas fa-sun"></i> Morning</div>
          <div style="font-size:1.05rem;">${en.morning.join(', ')}</div>
          <div style="font-size:1.05rem; font-family:'Noto Sans Tamil','Latha',sans-serif; color:#444; margin-top:3px;">
            ${ta.morning.join(', ')}
          </div>
        </div>
        <div>
          <div style="font-weight:600; margin-bottom:6px; color:#2c5a8c;"><i class="fas fa-moon"></i> Evening</div>
          <div style="font-size:1.05rem;">${en.evening.join(', ')}</div>
          <div style="font-size:1.05rem; font-family:'Noto Sans Tamil','Latha',sans-serif; color:#444; margin-top:3px;">
            ${ta.evening.join(', ')}
          </div>
        </div>
        <div style="margin-top:16px; text-align:center; font-size:0.85rem; color:#666;">
          тАФ New Jerusalem Church
        </div>
      `;
      document.body.appendChild(card);
      const canvas = await html2canvas(card, {
        scale: 2,
        backgroundColor: '#ffffff',
        logging: false
      });
      document.body.removeChild(card);
      return new Promise((resolve) => {
        canvas.toBlob(blob => resolve(blob), 'image/png');
      });
    }
    async function shareReadings() {
      try {
        const blob = await shareReadingsAsImage();
        if (!blob) throw new Error('Image creation failed');
        const file = new File([blob], 'NJC_Bible_Reading.png', { type: 'image/png' });
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
          await navigator.share({
            title: 'TodayтАЩs Bible Reading',
            text: 'ЁЯУЦ My daily Bible reading from New Jerusalem Church',
            files: [file]
          });
        } else {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'NJC_Bible_Reading.png';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }
      } catch (err) {
        console.error('Share failed:', err);
      }
    }

    // === INIT ===
    window.addEventListener('load', () => {
      applySavedTheme();
      loadAppData();
    });
  </script>
</body>
</html>
