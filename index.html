<!DOCTYPE html>
<html lang="ta">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <meta name="description" content="One Year Bible тАФ New Jerusalem Church">
  <title>роТро░рпБ ро╡ро░рпБроЯ рокрпИрокро┐ро│рпН тАФ NJC</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Tamil:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root {
      --bg: #f8f9fa;
      --text: #212529;
      --text-secondary: #495057;
      --accent: #2c5a8c;
      --card: #ffffff;
      --border: #e0e0e0;
      --success: #28a745;
      --shadow: 0 3px 10px rgba(0,0,0,0.08);
    }
    .dark-mode {
      --bg: #121212;
      --text: #e0e0e0;
      --text-secondary: #b0b0b0;
      --card: #1e1e1e;
      --border: #333;
      --accent: #4da6ff;
      --success: #4caf50;
      --shadow: 0 3px 12px rgba(0,0,0,0.25);
    }
    .dark-mode .ref-ta {
      color: #d0d0d0;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background-color: var(--bg);
      color: var(--text);
      line-height: 1.5;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .watermark {
      position: fixed;
      bottom: 10px;
      right: 10px;
      opacity: 0.05;
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--text);
      pointer-events: none;
      z-index: -1;
      transform: rotate(-30deg);
    }
    .title-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: var(--card);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      z-index: 100;
      position: sticky;
      top: 0;
      left: 0;
      right: 0;
      border-bottom: 1px solid var(--border);
    }
    .title-bar h1 {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--accent);
      text-align: center;
      flex: 1;
      margin: 0 12px;
    }
    .nav-btn {
      background: var(--card);
      border: 1px solid var(--border);
      color: var(--text);
      font-size: 1.1rem;
      width: 40px;
      height: 40px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s ease;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin: 0 4px;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transform: scale(0.8);
    }
    .title-bar.show-nav .nav-btn {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
      transform: scale(1);
    }
    .nav-btn:hover {
      background: var(--bg);
      border-color: var(--accent);
      color: var(--accent);
      transform: translateY(-1px) scale(1);
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    .title-bar.show-nav .nav-btn:active {
      transform: translateY(0) scale(0.95);
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .dark-mode .nav-btn {
      background: var(--card);
      border-color: var(--border);
      color: var(--text);
    }
    .dark-mode .nav-btn:hover {
      background: var(--bg);
      border-color: var(--accent);
      color: var(--accent);
    }
    .tabs {
      display: flex;
      background: var(--card);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 60px;
      z-index: 99;
    }
    .tab-btn {
      flex: 1;
      padding: 12px 0;
      background: none;
      border: none;
      font-size: 0.95rem;
      font-weight: 600;
      color: #6c757d;
      cursor: pointer;
    }
    .tab-btn.active {
      color: var(--accent);
      border-bottom: 2px solid var(--accent);
    }
    .dark-mode .tab-btn { color: #aaa; }
    .dark-mode .tab-btn.active { color: var(--accent); }
    .content {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 16px;
      gap: 16px;
      overflow: hidden;
      margin-top: 0;
      padding-bottom: 70px; /* Add padding to prevent content from being hidden behind bottom bar */
    }
    #today-view {
      display: flex;
      flex-direction: column;
      gap: 16px;
      height: 100%;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 18px;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    #date-card {
      padding: 16px;
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #date-card .date-text {
      font-size: 1.15rem;
      font-weight: 600;
      color: var(--accent);
      text-align: center;
      width: 100%;
      opacity: 1;
      visibility: visible;
    }
    .section-title {
      font-size: 1.15rem;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    .verse-item {
      margin: 6px 0;
      cursor: pointer;
    }
    .verse-item:hover {
      opacity: 0.8;
    }
    .ref-en {
      font-weight: 600;
      font-size: 1.1rem;
      color: var(--text);
    }
    .ref-ta {
      font-size: 1.1rem;
      color: var(--text-secondary);
      font-family: "Noto Sans Tamil", "Latha", sans-serif;
      margin-top: 4px;
    }
    #calendar-view,
    #bible-view {
      display: none;
      flex: 1;
      overflow-y: auto;
      padding: 8px;
      padding-top: 20px; /* Add padding at top to prevent content from being hidden under sticky title/tabs */
      padding-bottom: 80px; /* Add padding to prevent content from being hidden behind bottom bar */
      position: relative;
    }
    #bible-view {
      padding-top: 8px; /* Less padding for Bible view since it has its own selector row */
    }
    .selector-row {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    .selector-row select {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--card);
      color: var(--text);
      font-size: 0.95rem;
    }
    .search-container {
      margin: 8px 0;
    }
    .search-input-wrapper {
      position: relative;
      width: 100%;
    }
    #bible-search {
      width: 100%;
      padding: 8px 35px 8px 8px;
      margin: 0 0 8px 0;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--card);
      color: var(--text);
      font-size: 0.95rem;
      display: block;
      box-sizing: border-box;
    }
    .search-loading {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--accent);
      pointer-events: none;
    }
    .search-filters {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 4px;
    }
    .search-filter-btn {
      flex: 1;
      min-width: 80px;
      padding: 6px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--bg);
      color: var(--text);
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }
    .search-filter-btn:hover {
      background: var(--card);
      border-color: var(--accent);
    }
    .search-filter-btn.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }
    @media (max-width: 480px) {
      .search-filter-btn {
        font-size: 0.75rem;
        padding: 5px 8px;
        min-width: 60px;
      }
    }
    .verse-display {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      box-shadow: var(--shadow);
      font-family: "Noto Sans Tamil", "Latha", sans-serif;
      font-size: 1.1rem;
      line-height: 1.6;
      text-align: left;
    }
    .parallel-reading {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .parallel-reading .verse-panel {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      box-shadow: var(--shadow);
      font-size: 1rem;
      line-height: 1.6;
      text-align: left;
      max-height: 70vh;
      overflow-y: auto;
    }
    .parallel-reading .verse-panel.english {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
    .parallel-reading .verse-panel.tamil {
      font-family: "Noto Sans Tamil", "Latha", sans-serif;
    }
    .parallel-reading .verse-panel .panel-header {
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--border);
      font-size: 1.1rem;
    }
    @media (max-width: 768px) {
      .parallel-reading {
        grid-template-columns: 1fr;
      }
    }
    .verse-display .verse-num {
      color: var(--accent);
      font-weight: bold;
      margin-right: 6px;
    }
    .verse-highlighted {
      background-color: rgba(44, 90, 140, 0.15) !important;
      padding: 8px 12px !important;
      border-radius: 8px !important;
      border-left: 4px solid var(--accent) !important;
      animation: highlightFade 0.5s ease-in;
    }
    @keyframes highlightFade {
      from {
        background-color: rgba(44, 90, 140, 0.3);
      }
      to {
        background-color: rgba(44, 90, 140, 0.15);
      }
    }
    .dark-mode .verse-highlighted {
      background-color: rgba(77, 166, 255, 0.2) !important;
      border-left-color: var(--accent) !important;
    }
    .verse-select-mode .verse-display p {
      cursor: pointer;
      user-select: none;
      transition: all 0.2s ease;
    }
    .verse-select-mode .verse-display p:hover {
      background: rgba(44, 90, 140, 0.1);
      border-radius: 4px;
    }
    .verse-selected {
      background: rgba(44, 90, 140, 0.25) !important;
      border-left: 4px solid var(--accent) !important;
      padding-left: 12px !important;
      box-shadow: 0 2px 4px rgba(44, 90, 140, 0.2);
    }
    .verse-select-mode .verse-selected {
      background: rgba(76, 175, 80, 0.2) !important;
      border-left: 4px solid var(--success) !important;
    }
    .parallel-lang-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .parallel-lang-modal-content {
      background: var(--card);
      padding: 24px;
      border-radius: 16px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    .parallel-lang-selector {
      margin: 12px 0;
    }
    .parallel-lang-selector label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: var(--text);
    }
    .parallel-lang-selector select {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg);
      color: var(--text);
      font-size: 1rem;
    }
    .search-result-item {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      cursor: pointer;
      transition: all 0.2s ease;
      display: block;
      text-decoration: none;
      color: inherit;
    }
    .search-result-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border-color: var(--accent);
      background: var(--bg);
    }
    .search-result-item:active {
      transform: translateY(0);
    }
    .search-result-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .search-result-ref {
      color: var(--accent);
      font-weight: 600;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .search-result-ref i {
      font-size: 0.85rem;
      opacity: 0.7;
    }
    .search-result-text {
      color: var(--text);
      font-size: 1rem;
      line-height: 1.5;
      font-family: "Noto Sans Tamil", "Latha", sans-serif;
      margin-top: 6px;
    }
    .search-results-count {
      padding: 12px 16px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      margin-bottom: 12px;
      color: var(--accent);
      font-weight: 600;
      text-align: center;
      font-size: 0.95rem;
    }
    .bottom-bar {
      display: flex;
      justify-content: space-around;
      padding: 10px 16px;
      padding-bottom: max(10px, env(safe-area-inset-bottom, 10px));
      gap: 12px;
      background: var(--card);
      border-top: 1px solid var(--border);
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 100;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
      flex-shrink: 0;
    }
    .bottom-bar button {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      background: none;
      color: #6c757d;
      border: none;
      flex: 1;
      max-width: 48%;
      padding: 12px;
      border-radius: 0;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      min-height: 50px;
      -webkit-tap-highlight-color: rgba(0,0,0,0.1);
      transition: color 0.2s ease;
    }
    .bottom-bar button:hover {
      color: var(--accent);
      opacity: 0.8;
    }
    .dark-mode .bottom-bar button {
      color: #aaa;
    }
    .dark-mode .bottom-bar button:hover {
      color: var(--accent);
    }
    .bottom-bar button i { font-size: 1.1rem; }
    /* === FIXED NAV BUTTONS === */
    #bible-nav-buttons {
      display: flex;
      position: sticky;
      bottom: 10px;
      left: 0;
      right: 0;
      z-index: 5;
      justify-content: center;
      gap: 16px;
    }
    #bible-nav-buttons button {
      padding: 10px 20px;
      background: none;
      color: #6c757d;
      border: none;
      border-radius: 0;
      font-weight: 600;
      font-size: 0.95rem;
      min-width: 80px;
      cursor: pointer;
      transition: color 0.2s ease;
    }
    #bible-nav-buttons button:hover {
      color: var(--accent);
      opacity: 0.8;
    }
    .dark-mode #bible-nav-buttons button {
      color: #aaa;
    }
    .dark-mode #bible-nav-buttons button:hover {
      color: var(--accent);
    }
  </style>
</head>
<body>
  <div class="title-bar">
    <button class="nav-btn" onclick="goToDay(-1)" aria-label="Previous">
      <i class="fas fa-chevron-left"></i>
    </button>
    <h1>One Year Bible</h1>
    <button class="nav-btn" id="today-btn" onclick="goToToday()" style="display:none;" aria-label="Go to today">
      <i class="fas fa-home"></i>
    </button>
    <button class="nav-btn" onclick="toggleTheme()" aria-label="Toggle theme" id="theme-toggle">
      <i class="fas fa-moon"></i>
    </button>
  </div>
  <div class="tabs">
    <button class="tab-btn active" onclick="showTab('today')">Today</button>
    <button class="tab-btn" onclick="showTab('calendar')">Calendar</button>
    <button class="tab-btn" onclick="showTab('bible')">Bible</button>
  </div>
  <div class="content">
    <div id="today-view">
      <div class="card" id="date-card">
        <div class="date-text" id="today-date">Loading...</div>
      </div>
      <div class="card">
        <div class="section-title"><i class="fas fa-sun"></i> Morning</div>
        <div id="morning-list"></div>
      </div>
      <div class="card">
        <div class="section-title"><i class="fas fa-moon"></i> Evening</div>
        <div id="evening-list"></div>
      </div>
    </div>
    <div id="calendar-view"></div>
    <div id="bible-view">
      <div class="selector-row" style="margin-bottom: 8px; gap: 8px; margin-top: 8px;">
        <select id="bible-language-select" onchange="switchBibleLanguage()" style="flex: 1; min-width: 140px; padding: 8px 16px; background: var(--accent); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.9rem; display: none; appearance: none; background-image: url('data:image/svg+xml;charset=UTF-8,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\' fill=\'white\'%3E%3Cpath d=\'M7 10l5 5 5-5z\'/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 8px center; background-size: 20px; padding-right: 35px;">
          <option value="tamil">ЁЯУЦ Tamil</option>
          <option value="english">ЁЯУЦ English</option>
          <option value="dutch">ЁЯУЦ Dutch</option>
        </select>
        <button id="parallel-toggle" onclick="toggleParallelReading()" style="display: none; flex: 0 0 auto; padding: 8px 16px; background: var(--success); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.9rem;">
          <i class="fas fa-columns"></i> <span id="parallel-text">Parallel</span>
        </button>
        <button id="select-verses-btn" onclick="toggleVerseSelection()" style="display: none; flex: 0 0 auto; padding: 8px 16px; background: var(--warning); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.9rem;">
          <i class="fas fa-check-square"></i> <span id="select-verses-text">Select</span>
        </button>
        <button id="share-verses-btn" onclick="shareSelectedVerses()" style="display: none; flex: 0 0 auto; padding: 8px 16px; background: var(--accent); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.9rem; opacity: 0.5; pointer-events: none;">
          <i class="fas fa-share"></i> Share
        </button>
      </div>
      <div class="selector-row">
        <select id="book-select" onchange="loadChapters()" disabled><option>рокрпБродрпНродроХроорпН родрпЗро░рпНро╡рпБ роЪрпЖропрпНропрокрпНрокроЯро╡ро┐ро▓рпНро▓рпИ</option></select>
        <select id="chapter-select" onchange="loadVerses()" disabled><option>роЕродро┐роХро╛ро░роорпН родрпЗро░рпНро╡рпБ роЪрпЖропрпНропрокрпНрокроЯро╡ро┐ро▓рпНро▓рпИ</option></select>
      </div>
      <div class="search-container">
        <div class="search-input-wrapper">
          <input type="text" id="bible-search" placeholder="Search in any language..." oninput="onSearchInput(this.value)">
          <div id="search-loading" class="search-loading" style="display: none;">
            <i class="fas fa-spinner fa-spin"></i>
          </div>
        </div>
        <div class="search-filters">
          <button class="search-filter-btn active" data-filter="all" onclick="setSearchFilter('all')">
            <i class="fas fa-book-open"></i> Whole Bible
          </button>
          <button class="search-filter-btn" data-filter="ot" onclick="setSearchFilter('ot')">
            <i class="fas fa-scroll"></i> OT
          </button>
          <button class="search-filter-btn" data-filter="nt" onclick="setSearchFilter('nt')">
            <i class="fas fa-book"></i> NT
          </button>
          <button class="search-filter-btn" data-filter="book" onclick="setSearchFilter('book')">
            <i class="fas fa-bookmark"></i> This Book
          </button>
        </div>
      </div>
      <div class="verse-display" id="verse-display">
        рокрпИрокро┐ро│рпН роПро▒рпНро▒рокрпНрокроЯрпБроХро┐ро▒родрпБ...
      </div>
      <div id="bible-nav-buttons">
        <button id="prev-chap-btn" onclick="navigateChapter(-1)">тЖР Prev</button>
        <button id="next-chap-btn" onclick="navigateChapter(1)">Next тЖТ</button>
      </div>
    </div>
  </div>
  <div class="bottom-bar">
    <button class="progress-btn" onclick="markAsRead()">
      <i class="fas fa-check-circle"></i> Mark Read
    </button>
    <button class="share-btn" onclick="shareReadings()">
      <i class="fas fa-share-alt"></i> Share
    </button>
  </div>
  <div class="watermark">JayathaSoft</div>

  <script>
    // === GLOBALS ===
    let TAMIL_BIBLE = null;
    let ENGLISH_BIBLE = null;
    let DUTCH_BIBLE = null;
    let CURRENT_BIBLE = null; // Currently active Bible (TAMIL_BIBLE, ENGLISH_BIBLE, or DUTCH_BIBLE)
    let CURRENT_LANGUAGE = 'tamil'; // 'tamil', 'english', or 'dutch'
    let PARALLEL_MODE = false; // Parallel reading mode
    let PARALLEL_LANG1 = 'tamil'; // First language for parallel reading
    let PARALLEL_LANG2 = 'english'; // Second language for parallel reading
    let SELECTED_VERSES = new Set(); // Track selected verses for sharing
    let READING_PLAN_EN = [];
    let READING_PLAN_TA = [];
    let TAMIL_MAP = {};
    let BOOK_INDEX_MAP = {}; // Maps English abbreviations to book indices
    const TAMIL_BOOK_NAMES = [
      "роЖродро┐ропро╛роХроороорпН", "ропро╛родрпНродро┐ро░ро╛роХроороорпН", "ро▓рпЗро╡ро┐ропро░ро╛роХроороорпН", "роОрогрпНрогро╛роХроороорпН", "роЙрокро╛роХроороорпН", "ропрпЛроЪрпБро╡ро╛", "роиро┐ропро╛ропро╛родро┐рокродро┐роХро│рпН", "ро░рпВродрпН", "1 роЪро╛роорпБро╡рпЗро▓рпН",
      "2 роЪро╛роорпБро╡рпЗро▓рпН", "1 роЗро░ро╛роЬро╛роХрпНроХро│рпН", "2 роЗро░ро╛роЬро╛роХрпНроХро│рпН", "1 роиро╛ро│ро╛роХроороорпН", "2 роиро╛ро│ро╛роХроороорпН", "роОро╕рпНро▒ро╛", "роирпЖроХрпЗрооро┐ропро╛", "роОро╕рпНродро░рпН", "ропрпЛрокрпБ",
      "роЪроЩрпНроХрпАродроорпН", "роирпАродро┐роорпКро┤ро┐роХро│рпН", "рокро┐ро░роЪроЩрпНроХро┐", "роЙройрпНройродрокрпНрокро╛роЯрпНроЯрпБ", "роПроЪро╛ропро╛", "роОро░рпЗрооро┐ропро╛", "рокрпБро▓роорпНрокро▓рпН", "роОроЪрпЗроХрпНроХро┐ропрпЗро▓рпН", "родро╛ройро┐ропрпЗро▓рпН", "роУроЪро┐ропро╛",
      "ропрпЛро╡рпЗро▓рпН", "роЖроорпЛро╕рпН", "роТрокродро┐ропро╛", "ропрпЛройро╛", "роорпАроХро╛", "роиро╛роХрпВроорпН", "роЖрокроХрпВроХрпН", "роЪрпЖрокрпНрокройро┐ропро╛", "роЖроХро╛ропрпН", "роЪроХро░ро┐ропро╛", "рооро▓рпНроХро┐ропро╛",
      "роородрпНродрпЗропрпБ", "рооро╛ро▒рпНроХрпБ", "ро▓рпБрпВроХрпНроХро╛", "ропрпЛро╡ро╛ройрпН", "роЕрокрпНрокрпЛро╕рпНродро▓ро░рпН", "ро░рпЛрооро░рпН", "1 роХрпКро░ро┐роирпНродро┐ропро░рпН", "2 роХрпКро░ро┐роирпНродро┐ропро░рпН", "роХро▓ро╛родрпНродро┐ропро░рпН",
      "роОрокрпЗроЪро┐ропро░рпН", "рокро┐ро▓ро┐рокрпНрокро┐ропро░рпН", "роХрпКро▓рпЛроЪрпЖропро░рпН", "1 родрпЖроЪро▓рпЛройро┐роХрпНроХрпЗропро░рпН", "2 родрпЖроЪро▓рпЛройро┐роХрпНроХрпЗропро░рпН", "1 родрпАроорпЛродрпНродрпЗропрпБ", "2 родрпАроорпЛродрпНродрпЗропрпБ", "родрпАродрпНродрпБ",
      "рокро┐ро▓рпЗроорпЛройрпН", "роОрокро┐ро░рпЖропро░рпН", "ропро╛роХрпНроХрпЛрокрпБ", "1 рокрпЗродрпБро░рпБ", "2 рокрпЗродрпБро░рпБ", "1 ропрпЛро╡ро╛ройрпН", "2 ропрпЛро╡ро╛ройрпН", "3 ропрпЛро╡ро╛ройрпН", "ропрпВродро╛", "ро╡рпЖро│ро┐"
    ];
    const ENGLISH_BOOK_NAMES = [
      "Genesis", "Exodus", "Leviticus", "Numbers", "Deuteronomy", "Joshua", "Judges", "Ruth", "1 Samuel",
      "2 Samuel", "1 Kings", "2 Kings", "1 Chronicles", "2 Chronicles", "Ezra", "Nehemiah", "Esther", "Job",
      "Psalms", "Proverbs", "Ecclesiastes", "Song of Songs", "Isaiah", "Jeremiah", "Lamentations", "Ezekiel", "Daniel", "Hosea",
      "Joel", "Amos", "Obadiah", "Jonah", "Micah", "Nahum", "Habakkuk", "Zephaniah", "Haggai", "Zechariah", "Malachi",
      "Matthew", "Mark", "Luke", "John", "Acts", "Romans", "1 Corinthians", "2 Corinthians", "Galatians",
      "Ephesians", "Philippians", "Colossians", "1 Thessalonians", "2 Thessalonians", "1 Timothy", "2 Timothy", "Titus",
      "Philemon", "Hebrews", "James", "1 Peter", "2 Peter", "1 John", "2 John", "3 John", "Jude", "Revelation"
    ];
    // Dutch book names (same as English, as they use standard Bible book names)
    const DUTCH_BOOK_NAMES = ENGLISH_BOOK_NAMES;

    // === CLICK HANDLER FOR REFERENCES ===
    function openBibleReference(ref) {
      if (!CURRENT_BIBLE) {
        CURRENT_BIBLE = TAMIL_BIBLE;
      }
      if (!CURRENT_BIBLE) {
        alert('рокрпИрокро┐ро│рпН роЗройрпНройрпБроорпН роПро▒рпНро▒рокрпНрокроЯро╡ро┐ро▓рпНро▓рпИ.');
        return;
      }

      // Extract book and chapter
      // Handle formats like: "Mat.1", "Gen.1-3", "Mat.5:1-26"
      let bookKey = '';
      let chapterNum = 1;

      // Try English format - matches book abbreviation followed by chapter number
      // Handles: "Mat.1", "Gen.1-3", "Mat.5:1-26", etc.
      const engMatch = ref.match(/^([A-Za-z]+\.)(\d+)/);
      if (engMatch) {
        bookKey = engMatch[1];
        chapterNum = parseInt(engMatch[2], 10);
      } else {
        // Try Tamil format (e.g., "роЖродро┐.1", "роородрпН.5:1-26")
        const taMatch = ref.match(/^([^\d\s]+?)\.(\d+)/);
        if (taMatch) {
          const taBook = taMatch[1] + '.';
          chapterNum = parseInt(taMatch[2], 10);
          // Find English key from TAMIL_MAP
          for (const [en, ta] of Object.entries(TAMIL_MAP)) {
            if (ta === taBook) {
              bookKey = en;
              break;
            }
          }
        }
      }

      if (!bookKey) {
        console.warn('Could not parse reference:', ref);
        return;
      }

      // Find book index using BOOK_INDEX_MAP
      const bookIndex = BOOK_INDEX_MAP[bookKey];
      if (bookIndex === undefined || bookIndex < 0 || bookIndex >= CURRENT_BIBLE.books.length) {
        console.warn('Book not found:', bookKey);
        return;
      }

      // Ensure chapter number is valid (1-indexed to 0-indexed conversion)
      const maxChap = CURRENT_BIBLE.books[bookIndex].chapters.length;
      const safeChapter = Math.max(0, Math.min(chapterNum - 1, maxChap - 1));

      // Navigate to the book and chapter
      navigateToBookChapter(bookIndex, safeChapter);
    }
    
    // Navigate to specific book and chapter by index, optionally scroll to verse
    function navigateToBookChapter(bookIndex, chapterIndex, verseIndex = null) {
      if (!CURRENT_BIBLE) {
        CURRENT_BIBLE = TAMIL_BIBLE;
      }
      if (bookIndex < 0 || bookIndex >= CURRENT_BIBLE.books.length) {
        console.warn('Invalid book index:', bookIndex);
        return;
      }
      
      // Ensure chapter index is valid
      const maxChap = CURRENT_BIBLE.books[bookIndex].chapters.length;
      const safeChapter = Math.max(0, Math.min(chapterIndex, maxChap - 1));
      
      // Switch to Bible tab and load the correct book and chapter
      showTab('bible');
      setTimeout(() => {
        const bookSelect = document.getElementById('book-select');
        const chapterSelect = document.getElementById('chapter-select');
        
        // Set book
        bookSelect.value = bookIndex;
        loadChapters();
        
        // Wait a bit more for chapters to load, then set chapter
        setTimeout(() => {
          chapterSelect.value = safeChapter;
          loadVerses();
          
          // Scroll to specific verse if provided
          if (verseIndex !== null && verseIndex !== undefined) {
            setTimeout(() => {
              scrollToVerse(verseIndex);
            }, 100);
          } else {
            // Scroll to verse display
            setTimeout(() => {
              document.getElementById('verse-display').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
              });
            }, 50);
          }
        }, 50);
      }, 100);
    }
    
    // Scroll to and highlight a specific verse
    function scrollToVerse(verseIndex) {
      const display = document.getElementById('verse-display');
      const verseNum = verseIndex + 1; // verseIndex is 0-based, verseNum is 1-based
      
      // Remove previous highlights
      display.querySelectorAll('.verse-highlighted').forEach(el => {
        el.classList.remove('verse-highlighted');
      });
      
      // Find the verse element (could be in regular display or parallel mode)
      let verseElement = null;
      
      // Try to find in regular verse display (single language mode)
      const verseElements = display.querySelectorAll('p');
      verseElements.forEach(p => {
        const verseNumEl = p.querySelector('.verse-num');
        if (verseNumEl && parseInt(verseNumEl.textContent.trim()) === verseNum) {
          verseElement = p;
        }
      });
      
      // If not found, try in parallel mode - look for div containing "Verse X"
      if (!verseElement) {
        const allDivs = display.querySelectorAll('div');
        allDivs.forEach(div => {
          const divText = div.textContent || '';
          // Check if this div contains "Verse X" pattern
          const verseMatch = divText.match(/Verse\s+(\d+)/);
          if (verseMatch && parseInt(verseMatch[1]) === verseNum) {
            // Check if this is the container div with the verse number header
            const style = div.getAttribute('style') || '';
            if (style.includes('Verse') || div.querySelector('div[style*="Verse"]')) {
              verseElement = div;
            }
          }
        });
      }
      
      // Alternative: search by looking for the verse number in any text
      if (!verseElement) {
        const allElements = display.querySelectorAll('p, div');
        allElements.forEach(el => {
          const text = el.textContent || '';
          // Look for patterns like "Verse 1", "1", or verse number at start
          if (text.trim().startsWith(`Verse ${verseNum}`) || 
              text.trim().startsWith(`${verseNum} `) ||
              (el.innerHTML && el.innerHTML.includes(`Verse ${verseNum}`))) {
            verseElement = el;
          }
        });
      }
      
      if (verseElement) {
        // Highlight the verse
        verseElement.classList.add('verse-highlighted');
        
        // Scroll to the verse with some offset
        setTimeout(() => {
          verseElement.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'center' 
          });
        }, 50);
        
        // Remove highlight after 3 seconds
        setTimeout(() => {
          if (verseElement && verseElement.classList.contains('verse-highlighted')) {
            verseElement.classList.remove('verse-highlighted');
          }
        }, 3000);
      } else {
        // Fallback: scroll to verse display
        setTimeout(() => {
          display.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'start' 
          });
        }, 50);
      }
    }

    // === LOAD EXTERNAL DATA ===
    async function loadAppData() {
      try {
        // Load Tamil Bible
        const bibleRes = await fetch('bibles/tamilbible.json');
        const bibleData = await bibleRes.json();
        TAMIL_BIBLE = {
          books: bibleData.Book.map((bookObj, index) => {
            const name = TAMIL_BOOK_NAMES[index] || `рокрпБродрпНродроХроорпН ${index + 1}`;
            const chapters = bookObj.Chapter ? bookObj.Chapter.map(ch =>
              ch.Verse ? ch.Verse.map(v => v.Verse || '') : []
            ) : [];
            return { name, chapters };
          })
        };
        
        // Load English Bible (if exists)
        try {
          const englishBibleRes = await fetch('bibles/englishbible.json');
          if (englishBibleRes.ok) {
            const englishBibleData = await englishBibleRes.json();
            ENGLISH_BIBLE = {
              books: englishBibleData.Book.map((bookObj, index) => {
                const name = ENGLISH_BOOK_NAMES[index] || `Book ${index + 1}`;
                const chapters = bookObj.Chapter ? bookObj.Chapter.map(ch =>
                  ch.Verse ? ch.Verse.map(v => v.Verse || '') : []
                ) : [];
                return { name, chapters };
              })
            };
          }
        } catch (err) {
          console.warn('English Bible not found, using Tamil only');
        }
        
        // Load Dutch Bible (if exists) - has different structure
        try {
          const dutchBibleRes = await fetch('bibles/dutchbible.json');
          if (dutchBibleRes.ok) {
            const dutchBibleData = await dutchBibleRes.json();
            // Dutch Bible has structure: { books: [{ name, chapters: [{ verses: [{ text }] }] }] }
            if (dutchBibleData.books && Array.isArray(dutchBibleData.books)) {
              DUTCH_BIBLE = {
                books: dutchBibleData.books.map((bookObj, index) => {
                  const name = bookObj.name || DUTCH_BOOK_NAMES[index] || `Boek ${index + 1}`;
                  const chapters = bookObj.chapters ? bookObj.chapters.map(ch => {
                    // Sort chapters by chapter number to ensure correct order
                    return ch.verses ? ch.verses
                      .sort((a, b) => (a.verse || 0) - (b.verse || 0))
                      .map(v => v.text || '') : [];
                  }) : [];
                  return { name, chapters };
                })
              };
            }
          }
        } catch (err) {
          console.warn('Dutch Bible not found:', err);
        }
        
        // Set default Bible
        CURRENT_BIBLE = TAMIL_BIBLE;
        CURRENT_LANGUAGE = 'tamil';

        // Load Plan
        const planRes = await fetch('plan/njcplan.json');
        const planData = await planRes.json();
        READING_PLAN_EN = planData.readingPlan;
        TAMIL_MAP = planData.tamilMap;
        
        // Build BOOK_INDEX_MAP by matching Tamil abbreviations to TAMIL_BOOK_NAMES
        BOOK_INDEX_MAP = {};
        for (const [enAbbr, taAbbr] of Object.entries(TAMIL_MAP)) {
          // Remove the trailing period from Tamil abbreviation for matching
          const taAbbrClean = taAbbr.replace(/\.$/, '').trim();
          // Find matching book by checking if Tamil name starts with abbreviation
          const bookIndex = TAMIL_BOOK_NAMES.findIndex((name) => {
            // Extract number prefix if any (e.g., "1" from "1 роЪро╛роорпБро╡рпЗро▓рпН")
            const nameNumMatch = name.match(/^(\d+)\s+/);
            const abbrNumMatch = taAbbrClean.match(/^(\d+)\s+/);
            // Both must have same number prefix (or both have none)
            if ((nameNumMatch && !abbrNumMatch) || (!nameNumMatch && abbrNumMatch)) {
              return false;
            }
            if (nameNumMatch && abbrNumMatch && nameNumMatch[1] !== abbrNumMatch[1]) {
              return false;
            }
            // Remove number prefix and check if name starts with abbreviation
            const nameWithoutNum = name.replace(/^\d+\s+/, '').trim();
            const abbrWithoutNum = taAbbrClean.replace(/^\d+\s+/, '').trim();
            return nameWithoutNum.startsWith(abbrWithoutNum) || abbrWithoutNum.startsWith(nameWithoutNum.substring(0, 2));
          });
          if (bookIndex !== -1) {
            BOOK_INDEX_MAP[enAbbr] = bookIndex;
          } else {
            console.warn('Could not map book:', enAbbr, '->', taAbbr);
          }
        }

        READING_PLAN_TA = READING_PLAN_EN.map(day => ({
          morning: day.morning.map(r => {
            const ta = convertToTamil(r);
            return `<span onclick="openBibleReference('${r}')">${ta}</span>`;
          }),
          evening: day.evening.map(r => {
            const ta = convertToTamil(r);
            return `<span onclick="openBibleReference('${r}')">${ta}</span>`;
          })
        }));

        // Render today
        const now = new Date();
        const startOfYear = new Date(now.getFullYear(), 0, 1);
        const dayOfYear = Math.floor((now - startOfYear) / 86400000);
        renderReadings(Math.min(READING_PLAN_EN.length - 1, dayOfYear));

        document.getElementById('book-select').disabled = false;
        populateBooks();
        // Load chapters and verses with last read position
        setTimeout(() => {
          loadChapters(true); // This will also load verses
        }, 50);
        
        // Update Bible language dropdown
        updateBibleLanguageDropdown();
        
        // Update parallel toggle and other buttons
        const parallelToggle = document.getElementById('parallel-toggle');
        const selectVersesBtn = document.getElementById('select-verses-btn');
        const shareVersesBtn = document.getElementById('share-verses-btn');
        
        if (ENGLISH_BIBLE || DUTCH_BIBLE || TAMIL_BIBLE) {
          parallelToggle.style.display = 'flex';
          parallelToggle.style.justifyContent = 'center';
          parallelToggle.style.alignItems = 'center';
        }
        
        // Show select/share buttons if Bible is loaded
        if (CURRENT_BIBLE) {
          selectVersesBtn.style.display = 'flex';
          selectVersesBtn.style.justifyContent = 'center';
          selectVersesBtn.style.alignItems = 'center';
          shareVersesBtn.style.display = 'flex';
          shareVersesBtn.style.justifyContent = 'center';
          shareVersesBtn.style.alignItems = 'center';
        } else {
          selectVersesBtn.style.display = 'none';
          shareVersesBtn.style.display = 'none';
        }
      } catch (err) {
        console.error('Failed to load app data:', err);
        document.getElementById('verse-display').innerHTML = 'родро╡ро▒рпБ: ' + err.message;
      }
    }

    function convertToTamil(ref) {
      const books = Object.keys(TAMIL_MAP).sort((a, b) => b.length - a.length);
      for (const book of books) {
        if (ref.startsWith(book)) {
          return TAMIL_MAP[book] + ref.slice(book.length);
        }
      }
      return ref;
    }

    // === LANGUAGE SELECTION ===
    function updateBibleLanguageDropdown() {
      const select = document.getElementById('bible-language-select');
      if (!select) return;
      
      // Clear existing options
      select.innerHTML = '';
      
      // Add available languages
      if (TAMIL_BIBLE) {
        const option = document.createElement('option');
        option.value = 'tamil';
        option.textContent = 'ЁЯУЦ Tamil';
        option.selected = CURRENT_LANGUAGE === 'tamil';
        select.appendChild(option);
      }
      
      if (ENGLISH_BIBLE) {
        const option = document.createElement('option');
        option.value = 'english';
        option.textContent = 'ЁЯУЦ English';
        option.selected = CURRENT_LANGUAGE === 'english';
        select.appendChild(option);
      }
      
      if (DUTCH_BIBLE) {
        const option = document.createElement('option');
        option.value = 'dutch';
        option.textContent = 'ЁЯУЦ Dutch';
        option.selected = CURRENT_LANGUAGE === 'dutch';
        select.appendChild(option);
      }
      
      // Show dropdown if at least one alternative language is available (always show if multiple)
      const availableCount = (TAMIL_BIBLE ? 1 : 0) + (ENGLISH_BIBLE ? 1 : 0) + (DUTCH_BIBLE ? 1 : 0);
      if (availableCount > 1) {
        select.style.display = 'block';
      } else {
        select.style.display = 'none';
      }
    }
    
    function switchBibleLanguage() {
      const select = document.getElementById('bible-language-select');
      if (!select) return;
      
      const selectedLang = select.value;
      
      if (selectedLang === 'tamil' && TAMIL_BIBLE) {
        CURRENT_LANGUAGE = 'tamil';
        CURRENT_BIBLE = TAMIL_BIBLE;
      } else if (selectedLang === 'english' && ENGLISH_BIBLE) {
        CURRENT_LANGUAGE = 'english';
        CURRENT_BIBLE = ENGLISH_BIBLE;
      } else if (selectedLang === 'dutch' && DUTCH_BIBLE) {
        CURRENT_LANGUAGE = 'dutch';
        CURRENT_BIBLE = DUTCH_BIBLE;
      } else {
        return; // Invalid selection
      }
      
      // Load last read position for the new language
      const lastPos = loadLastReadPosition();
      populateBooks();
      // populateBooks already sets the book, now ensure chapters and verses load
      setTimeout(() => {
        loadChapters(true); // This will load verses with last position
      }, 50);
    }

    // === BIBLE UI FUNCTIONS ===
    function saveLastReadPosition(bookIndex, chapterIndex) {
      const position = {
        bookIndex: bookIndex,
        chapterIndex: chapterIndex,
        language: CURRENT_LANGUAGE
      };
      localStorage.setItem('lastBiblePosition', JSON.stringify(position));
    }
    
    function loadLastReadPosition() {
      try {
        const saved = localStorage.getItem('lastBiblePosition');
        if (saved) {
          const position = JSON.parse(saved);
          // Only use saved position if language matches
          if (position.language === CURRENT_LANGUAGE) {
            return {
              bookIndex: position.bookIndex || 0,
              chapterIndex: position.chapterIndex || 0
            };
          }
        }
      } catch (err) {
        console.warn('Failed to load last position:', err);
      }
      // Default to Genesis 1
      return { bookIndex: 0, chapterIndex: 0 };
    }
    
    function populateBooks() {
      const select = document.getElementById('book-select');
      select.innerHTML = '';
      if (!CURRENT_BIBLE) {
        CURRENT_BIBLE = TAMIL_BIBLE;
      }
      CURRENT_BIBLE.books.forEach((book, index) => {
        const opt = document.createElement('option');
        opt.value = index;
        opt.textContent = book.name;
        select.appendChild(opt);
      });
      // Load last read position or default to Genesis 1
      const lastPos = loadLastReadPosition();
      select.value = lastPos.bookIndex;
      loadChapters(false); // Don't auto-load verses yet
    }
    function loadChapters(autoLoadVerses = true) {
      const bookIndex = document.getElementById('book-select').value;
      const chapterSelect = document.getElementById('chapter-select');
      chapterSelect.innerHTML = '';
      if (bookIndex === '' || !CURRENT_BIBLE) return;
      const book = CURRENT_BIBLE.books[bookIndex];
      for (let i = 1; i <= book.chapters.length; i++) {
        const opt = document.createElement('option');
        opt.value = i - 1;
        opt.textContent = i;
        chapterSelect.appendChild(opt);
      }
      chapterSelect.disabled = false;
      
      // Load last read chapter or default to chapter 1
      const lastPos = loadLastReadPosition();
      if (lastPos.bookIndex == bookIndex) {
        chapterSelect.value = lastPos.chapterIndex;
      } else {
        chapterSelect.value = 0; // Default to chapter 1
      }
      
      if (autoLoadVerses) {
        loadVerses();
      }
    }
    function loadVerses() {
      const bookIndex = document.getElementById('book-select').value;
      const chapterIndex = document.getElementById('chapter-select').value;
      const display = document.getElementById('verse-display');
      if (bookIndex === '' || chapterIndex === '' || !CURRENT_BIBLE) {
        display.innerHTML = CURRENT_LANGUAGE === 'tamil' ? 'роЕродро┐роХро╛ро░родрпНродрпИродрпН родрпЗро░рпНроирпНродрпЖроЯрпБроХрпНроХро╡рпБроорпН.' : 'Please select a chapter.';
        return;
      }
      
      // Save current position
      saveLastReadPosition(parseInt(bookIndex), parseInt(chapterIndex));
      
      if (PARALLEL_MODE) {
        // Get Bibles for selected languages
        const getBibleForLang = (lang) => {
          if (lang === 'tamil') return TAMIL_BIBLE;
          if (lang === 'english') return ENGLISH_BIBLE;
          if (lang === 'dutch') return DUTCH_BIBLE;
          return null;
        };
        
        const getLangName = (lang) => {
          if (lang === 'tamil') return 'родрооро┐ро┤рпН';
          if (lang === 'english') return 'English';
          if (lang === 'dutch') return 'Dutch';
          return lang;
        };
        
        const getLangFont = (lang) => {
          if (lang === 'tamil') return "'Noto Sans Tamil', 'Latha', sans-serif";
          return "-apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif";
        };
        
        const bible1 = getBibleForLang(PARALLEL_LANG1);
        const bible2 = getBibleForLang(PARALLEL_LANG2);
        
        if (!bible1 || !bible2) {
          display.innerHTML = 'Both selected Bibles are required for parallel reading.';
          return;
        }
        
        // Parallel reading mode - merged verse by verse
        const chapter1 = bible1.books[bookIndex].chapters[chapterIndex];
        const chapter2 = bible2.books[bookIndex].chapters[chapterIndex];
        const maxVerses = Math.max(chapter1.length, chapter2.length);
        
        let html = '';
        html += '<div style="margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid var(--border);">';
        html += `<div style="font-weight: 600; color: var(--accent); font-size: 1.05rem;">${getLangName(PARALLEL_LANG1)} & ${getLangName(PARALLEL_LANG2)} - Parallel Reading</div>`;
        html += '</div>';
        
        const isSelectMode = document.body.classList.contains('verse-select-mode');
        
        // Merge verses verse by verse
        for (let verseIndex = 0; verseIndex < maxVerses; verseIndex++) {
          const verseNum = verseIndex + 1;
          const verse1 = chapter1[verseIndex] || '';
          const verse2 = chapter2[verseIndex] || '';
          const verseKey = `${bookIndex}-${chapterIndex}-${verseIndex}`;
          const isSelected = SELECTED_VERSES.has(verseKey);
          const selectedClass = isSelected ? 'verse-selected' : '';
          
          html += `<div data-verse-key="${verseKey}" class="${selectedClass}" style="margin-bottom: 16px; padding: 12px; background: var(--card); border: 1px solid var(--border); border-radius: 8px; ${isSelectMode ? 'cursor:pointer;' : ''}" ${isSelectMode ? `onclick="toggleVerseSelectionByKey('${verseKey}')"` : ''}>`;
          html += `<div style="font-weight: 600; color: var(--accent); margin-bottom: 8px;">Verse ${verseNum}</div>`;
          
          // First language verse
          if (verse1) {
            html += `<div style="margin-bottom: 10px; padding: 10px; background: rgba(44, 90, 140, 0.05); border-left: 3px solid var(--accent); border-radius: 4px;">`;
            html += `<div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 4px; font-weight: 600;">${getLangName(PARALLEL_LANG1)}</div>`;
            html += `<div style="font-family: ${getLangFont(PARALLEL_LANG1)}; font-size: 1rem; line-height: 1.6;">${verse1}</div>`;
            html += `</div>`;
          }
          
          // Second language verse
          if (verse2) {
            html += `<div style="padding: 10px; background: rgba(76, 175, 80, 0.05); border-left: 3px solid var(--success); border-radius: 4px;">`;
            html += `<div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 4px; font-weight: 600;">${getLangName(PARALLEL_LANG2)}</div>`;
            html += `<div style="font-family: ${getLangFont(PARALLEL_LANG2)}; font-size: 1rem; line-height: 1.6;">${verse2}</div>`;
            html += `</div>`;
          }
          
          html += `</div>`;
        }
        
        display.innerHTML = html;
      } else {
        // Single language mode
        const chapter = CURRENT_BIBLE.books[bookIndex].chapters[chapterIndex];
        let html = '';
        const isSelectMode = document.body.classList.contains('verse-select-mode');
        chapter.forEach((verseText, verseIndex) => {
          const verseNum = verseIndex + 1;
          const verseKey = `${bookIndex}-${chapterIndex}-${verseIndex}`;
          const isSelected = SELECTED_VERSES.has(verseKey);
          const selectedClass = isSelected ? 'verse-selected' : '';
          html += `<p data-verse-key="${verseKey}" class="${selectedClass}" ${isSelectMode ? 'onclick="toggleVerseSelectionByKey(\'' + verseKey + '\')"' : ''}><span class="verse-num">${verseNum}</span>${verseText}</p>`;
        });
        display.innerHTML = html || (CURRENT_LANGUAGE === 'tamil' ? 'ро╡роЪройроЩрпНроХро│рпН роХро┐роЯрпИроХрпНроХро╡ро┐ро▓рпНро▓рпИ.' : 'No verses found.');
      }
    }
    
    // Show parallel language selector modal
    function showParallelLangSelector() {
      const modal = document.createElement('div');
      modal.className = 'parallel-lang-modal';
      modal.innerHTML = `
        <div class="parallel-lang-modal-content">
          <h3 style="margin-top:0; margin-bottom:20px; color:var(--text);">Select Languages for Parallel Reading</h3>
          <div class="parallel-lang-selector">
            <label>First Language:</label>
            <select id="parallel-lang1">
              ${TAMIL_BIBLE ? `<option value="tamil" ${PARALLEL_LANG1 === 'tamil' ? 'selected' : ''}>Tamil</option>` : ''}
              ${ENGLISH_BIBLE ? `<option value="english" ${PARALLEL_LANG1 === 'english' ? 'selected' : ''}>English</option>` : ''}
              ${DUTCH_BIBLE ? `<option value="dutch" ${PARALLEL_LANG1 === 'dutch' ? 'selected' : ''}>Dutch</option>` : ''}
            </select>
          </div>
          <div class="parallel-lang-selector">
            <label>Second Language:</label>
            <select id="parallel-lang2">
              ${TAMIL_BIBLE ? `<option value="tamil" ${PARALLEL_LANG2 === 'tamil' ? 'selected' : ''}>Tamil</option>` : ''}
              ${ENGLISH_BIBLE ? `<option value="english" ${PARALLEL_LANG2 === 'english' ? 'selected' : ''}>English</option>` : ''}
              ${DUTCH_BIBLE ? `<option value="dutch" ${PARALLEL_LANG2 === 'dutch' ? 'selected' : ''}>Dutch</option>` : ''}
            </select>
          </div>
          <div style="display:flex; gap:10px; margin-top:20px;">
            <button onclick="saveParallelLanguages()" style="flex:1; padding:12px; background:var(--accent); color:white; border:none; border-radius:8px; font-weight:600; cursor:pointer;">Apply</button>
            <button onclick="closeParallelLangSelector()" style="flex:1; padding:12px; background:var(--border); color:var(--text); border:none; border-radius:8px; font-weight:600; cursor:pointer;">Cancel</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      
      // Close on background click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeParallelLangSelector();
        }
      });
    }
    
    function closeParallelLangSelector() {
      const modal = document.querySelector('.parallel-lang-modal');
      if (modal) {
        modal.remove();
      }
    }
    
    function saveParallelLanguages() {
      const lang1 = document.getElementById('parallel-lang1').value;
      const lang2 = document.getElementById('parallel-lang2').value;
      
      if (lang1 === lang2) {
        alert('Please select two different languages.');
        return;
      }
      
      PARALLEL_LANG1 = lang1;
      PARALLEL_LANG2 = lang2;
      closeParallelLangSelector();
      
      // Enable parallel mode if not already enabled
      if (!PARALLEL_MODE) {
        PARALLEL_MODE = true;
        document.getElementById('parallel-text').textContent = 'Single';
      }
      
      loadVerses();
    }
    
    // Toggle parallel reading mode
    function toggleParallelReading() {
      if (PARALLEL_MODE) {
        // Disable parallel mode
        PARALLEL_MODE = false;
        document.getElementById('parallel-text').textContent = 'Parallel';
      } else {
        // Show language selector to choose languages
        showParallelLangSelector();
        return;
      }
      
      // Reload current verses
      loadVerses();
    }
    
    // Verse selection functions
    let VERSE_SELECT_MODE = false;
    
    function toggleVerseSelection() {
      VERSE_SELECT_MODE = !VERSE_SELECT_MODE;
      document.body.classList.toggle('verse-select-mode', VERSE_SELECT_MODE);
      const selectText = document.getElementById('select-verses-text');
      if (selectText) {
        selectText.textContent = VERSE_SELECT_MODE ? 'Cancel' : 'Select';
      }
      
      if (!VERSE_SELECT_MODE) {
        // Clear selection when exiting select mode
        SELECTED_VERSES.clear();
      }
      
      // Reload verses to update click handlers
      loadVerses();
    }
    
    function toggleVerseSelectionByKey(verseKey) {
      if (!VERSE_SELECT_MODE) return;
      
      if (SELECTED_VERSES.has(verseKey)) {
        SELECTED_VERSES.delete(verseKey);
      } else {
        SELECTED_VERSES.add(verseKey);
      }
      
      // Update UI
      const verseElement = document.querySelector(`[data-verse-key="${verseKey}"]`);
      if (verseElement) {
        if (SELECTED_VERSES.has(verseKey)) {
          verseElement.classList.add('verse-selected');
        } else {
          verseElement.classList.remove('verse-selected');
        }
      }
      
      // Update share button visibility
      updateShareButtonVisibility();
    }
    
    function updateShareButtonVisibility() {
      const shareBtn = document.getElementById('share-verses-btn');
      if (shareBtn && SELECTED_VERSES.size > 0) {
        shareBtn.style.opacity = '1';
        shareBtn.style.pointerEvents = 'auto';
      } else if (shareBtn) {
        shareBtn.style.opacity = '0.5';
        shareBtn.style.pointerEvents = 'none';
      }
    }
    
    async function shareSelectedVerses() {
      if (SELECTED_VERSES.size === 0) {
        alert('Please select verses to share.');
        return;
      }
      
      const bookIndex = parseInt(document.getElementById('book-select').value);
      const chapterIndex = parseInt(document.getElementById('chapter-select').value);
      const bookName = CURRENT_BIBLE.books[bookIndex].name;
      const chapterNum = chapterIndex + 1;
      
      // Collect selected verses
      const verses = [];
      const sortedKeys = Array.from(SELECTED_VERSES).sort((a, b) => {
        const [, , v1] = a.split('-').map(Number);
        const [, , v2] = b.split('-').map(Number);
        return v1 - v2;
      });
      
      for (const verseKey of sortedKeys) {
        const [, , verseIndex] = verseKey.split('-').map(Number);
        const verseNum = verseIndex + 1;
        let verseText = '';
        
        if (PARALLEL_MODE) {
          // Get verses from both languages
          const getBibleForLang = (lang) => {
            if (lang === 'tamil') return TAMIL_BIBLE;
            if (lang === 'english') return ENGLISH_BIBLE;
            if (lang === 'dutch') return DUTCH_BIBLE;
            return null;
          };
          const bible1 = getBibleForLang(PARALLEL_LANG1);
          const bible2 = getBibleForLang(PARALLEL_LANG2);
          const verse1 = bible1?.books[bookIndex]?.chapters[chapterIndex]?.[verseIndex] || '';
          const verse2 = bible2?.books[bookIndex]?.chapters[chapterIndex]?.[verseIndex] || '';
          verseText = `${verse1}\n${verse2}`;
        } else {
          verseText = CURRENT_BIBLE.books[bookIndex].chapters[chapterIndex][verseIndex] || '';
        }
        
        verses.push({ verseNum, text: verseText });
      }
      
      // Create share image
      await shareVersesAsImage(bookName, chapterNum, verses);
    }
    
    async function shareVersesAsImage(bookName, chapterNum, verses) {
      if (!window.html2canvas) {
        await new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = 'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
          script.onload = resolve;
          script.onerror = reject;
          document.head.appendChild(script);
        });
      }
      
      const card = document.createElement('div');
      card.style.cssText = `
        position: fixed;
        left: -9999px;
        top: -9999px;
        width: 400px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 30px;
        border-radius: 20px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        color: #fff;
        line-height: 1.6;
        box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      `;
      
      let versesHtml = '';
      verses.forEach(v => {
        versesHtml += `<div style="margin-bottom: 16px; padding: 16px; background: rgba(255,255,255,0.15); border-radius:12px; backdrop-filter:blur(10px);">
          <div style="font-weight:600; margin-bottom:8px; color:#ffd700;">Verse ${v.verseNum}</div>
          <div style="font-size:1.1rem; text-align:center; line-height:1.6;">${v.text}</div>
        </div>`;
      });
      
      card.innerHTML = `
        <div style="text-align:center; margin-bottom:24px;">
          <div style="font-size:2.5rem; color:#ffd700; margin-bottom:8px;">
            <i class="fas fa-book-open"></i>
          </div>
          <div style="font-size:1.3rem; font-weight:700; margin-bottom:4px;">${bookName}</div>
          <div style="font-size:1rem; opacity:0.9;">Chapter ${chapterNum}</div>
        </div>
        ${versesHtml}
        <div style="margin-top:20px; text-align:center; font-size:0.85rem; opacity:0.8;">
          тАФ New Jerusalem Church
        </div>
      `;
      
      document.body.appendChild(card);
      const canvas = await html2canvas(card, {
        scale: 2,
        backgroundColor: null,
        logging: false
      });
      document.body.removeChild(card);
      
      const blob = await new Promise((resolve) => {
        canvas.toBlob(blob => resolve(blob), 'image/png');
      });
      
      const file = new File([blob], `Bible_${bookName}_${chapterNum}.png`, { type: 'image/png' });
      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        await navigator.share({
          title: `${bookName} ${chapterNum}`,
          text: 'ЁЯУЦ Selected Bible verses',
          files: [file]
        });
      } else {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Bible_${bookName}_${chapterNum}.png`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }
    }
    
    // Detect if text contains Tamil characters
    function isTamilText(text) {
      // Tamil Unicode range: U+0B80 to U+0BFF
      const tamilRegex = /[\u0B80-\u0BFF]/;
      return tamilRegex.test(text);
    }
    
    // Search state
    let searchFilter = 'all'; // 'all', 'ot', 'nt', 'book'
    let searchTimeout = null;
    const OLD_TESTAMENT_END = 38; // Malachi (0-indexed: 39 books, indices 0-38)
    const NEW_TESTAMENT_START = 39; // Matthew (0-indexed)
    
    function setSearchFilter(filter) {
      searchFilter = filter;
      // Update button states
      document.querySelectorAll('.search-filter-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`.search-filter-btn[data-filter="${filter}"]`).classList.add('active');
      
      // Re-run search if there's a query
      const searchInput = document.getElementById('bible-search');
      if (searchInput && searchInput.value.trim()) {
        performSearch(searchInput.value);
      }
    }
    
    function onSearchInput(query) {
      const display = document.getElementById('verse-display');
      const loadingEl = document.getElementById('search-loading');
      
      // Show loading immediately
      if (query.trim()) {
        loadingEl.style.display = 'block';
      }
      
      // Clear existing timeout
      if (searchTimeout) {
        clearTimeout(searchTimeout);
      }
      
      // Debounce: wait 300ms after user stops typing
      searchTimeout = setTimeout(() => {
        if (!query.trim()) {
          loadingEl.style.display = 'none';
          loadVerses();
          return;
        }
        performSearch(query);
      }, 300);
    }
    
    function performSearch(query) {
      const originalQuery = query.trim();
      const queryLower = originalQuery.toLowerCase();
      const display = document.getElementById('verse-display');
      const loadingEl = document.getElementById('search-loading');
      
      if (!originalQuery) {
        loadingEl.style.display = 'none';
        loadVerses();
        return;
      }
      
      // Auto-detect language and switch Bible if needed
      const isTamil = isTamilText(originalQuery);
      if (isTamil && CURRENT_LANGUAGE !== 'tamil') {
        // Switch to Tamil Bible
        if (TAMIL_BIBLE) {
          CURRENT_LANGUAGE = 'tamil';
          CURRENT_BIBLE = TAMIL_BIBLE;
          updateBibleLanguageDropdown();
          populateBooks();
        }
      } else if (!isTamil) {
        // For non-Tamil, prefer English if available, otherwise Dutch
        // Simple heuristic: if user types common English words, use English; otherwise could be Dutch
        const commonEnglishWords = /\b(the|and|is|in|to|of|a|that|it|with|for|as|was|on|are)\b/i;
        const isLikelyEnglish = commonEnglishWords.test(originalQuery);
        
        if (isLikelyEnglish && ENGLISH_BIBLE && CURRENT_LANGUAGE !== 'english') {
          CURRENT_LANGUAGE = 'english';
          CURRENT_BIBLE = ENGLISH_BIBLE;
          updateBibleLanguageDropdown();
          populateBooks();
        } else if (!isLikelyEnglish && DUTCH_BIBLE && CURRENT_LANGUAGE !== 'dutch') {
          // Try Dutch if not clearly English
          CURRENT_LANGUAGE = 'dutch';
          CURRENT_BIBLE = DUTCH_BIBLE;
          updateBibleLanguageDropdown();
          populateBooks();
        } else if (ENGLISH_BIBLE && CURRENT_LANGUAGE !== 'english') {
          // Fallback to English
          CURRENT_LANGUAGE = 'english';
          CURRENT_BIBLE = ENGLISH_BIBLE;
          updateBibleLanguageDropdown();
          populateBooks();
        }
      }
      
      if (!CURRENT_BIBLE) {
        loadingEl.style.display = 'none';
        const loadingMsg = CURRENT_LANGUAGE === 'tamil' ? 'рокрпИрокро┐ро│рпН роЗройрпНройрпБроорпН роПро▒рпНро▒рокрпНрокроЯро╡ро┐ро▓рпНро▓рпИ.' 
          : CURRENT_LANGUAGE === 'dutch' ? 'Bijbel wordt nog geladen.' 
          : 'Bible is still loading.';
        display.innerHTML = loadingMsg;
        return;
      }
      
      // Determine search range based on filter
      let startBookIndex = 0;
      let endBookIndex = CURRENT_BIBLE.books.length - 1;
      
      if (searchFilter === 'ot') {
        startBookIndex = 0;
        endBookIndex = OLD_TESTAMENT_END;
      } else if (searchFilter === 'nt') {
        startBookIndex = NEW_TESTAMENT_START;
        endBookIndex = CURRENT_BIBLE.books.length - 1;
      } else if (searchFilter === 'book') {
        const bookSelect = document.getElementById('book-select');
        const selectedBookIndex = parseInt(bookSelect.value);
        if (selectedBookIndex >= 0 && selectedBookIndex < CURRENT_BIBLE.books.length) {
          startBookIndex = selectedBookIndex;
          endBookIndex = selectedBookIndex;
        }
      }
      
      // Perform search - optimized for performance
      let results = [];
      const maxResults = 500; // Limit results for performance
      
      // Search with timeout for large searches
      const searchStartTime = Date.now();
      const maxSearchTime = 2000; // Max 2 seconds
      
      for (let bookIndex = startBookIndex; bookIndex <= endBookIndex && results.length < maxResults; bookIndex++) {
        // Check timeout for very large searches
        if (Date.now() - searchStartTime > maxSearchTime && results.length > 0) {
          break; // Stop if taking too long but we have some results
        }
        
        const book = CURRENT_BIBLE.books[bookIndex];
        if (!book) continue;
        
        book.chapters.forEach((chapter, chapIndex) => {
          if (results.length >= maxResults) return;
          chapter.forEach((verseText, verseIndex) => {
            if (results.length >= maxResults) return;
            // Case-insensitive search
            if (verseText.toLowerCase().includes(queryLower)) {
              results.push({
                bookIndex: bookIndex,
                book: book.name,
                chapter: chapIndex + 1,
                chapterIndex: chapIndex,
                verseNum: verseIndex + 1,
                text: verseText
              });
            }
          });
        });
      }
      
      // Search complete
      loadingEl.style.display = 'none';
      renderSearchResults(results, originalQuery);
    }
    
    function renderSearchResults(results, originalQuery) {
      const display = document.getElementById('verse-display');
      
      if (results.length === 0) {
        const noResultsMsg = CURRENT_LANGUAGE === 'tamil' ? 'родрпЗроЯро▓рпН роорпБроЯро┐ро╡рпБроХро│рпН роЗро▓рпНро▓рпИ.' 
          : CURRENT_LANGUAGE === 'dutch' ? 'Geen zoekresultaten gevonden.' 
          : 'No search results found.';
        display.innerHTML = `<div class="search-results-count" style="color:var(--text-secondary);">${noResultsMsg}</div>`;
        return;
      }
      
      // Highlight search query in results
      const highlightQuery = (text, searchQuery) => {
        const regex = new RegExp(`(${searchQuery.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
        const isDark = document.body.classList.contains('dark-mode');
        const bgColor = isDark ? 'rgba(77, 166, 255, 0.3)' : 'rgba(44, 90, 140, 0.2)';
        return text.replace(regex, `<mark style="background-color:${bgColor}; padding:2px 0; border-radius:2px; font-weight:500;">$1</mark>`);
      };
      
      const resultsMsg = CURRENT_LANGUAGE === 'tamil' 
        ? `${results.length} роорпБроЯро┐ро╡рпБроХро│рпН роХро┐роЯрпИродрпНродрой` 
        : CURRENT_LANGUAGE === 'dutch'
        ? `${results.length} resultaten gevonden`
        : `${results.length} results found`;
      
      let html = `<div class="search-results-count"><i class="fas fa-search"></i> ${resultsMsg}</div>`;
      results.forEach((r, idx) => {
        html += `<div class="search-result-item" onclick="navigateToBookChapter(${r.bookIndex}, ${r.chapterIndex}, ${r.verseNum - 1})" role="button" tabindex="0" onkeypress="if(event.key==='Enter') navigateToBookChapter(${r.bookIndex}, ${r.chapterIndex}, ${r.verseNum - 1})">
                  <div class="search-result-header">
                    <div class="search-result-ref">
                      <i class="fas fa-book"></i>
                      ${r.book} ${r.chapter}:${r.verseNum}
                    </div>
                  </div>
                  <div class="search-result-text">${highlightQuery(r.text, originalQuery)}</div>
                </div>`;
      });
      display.innerHTML = html;
    }
    
    // Keep the old function name for backward compatibility
    function searchWholeBible(query) {
      onSearchInput(query);
    }
    function navigateChapter(direction) {
      const bookSelect = document.getElementById('book-select');
      const chapterSelect = document.getElementById('chapter-select');
      const bookIndex = parseInt(bookSelect.value);
      const chapterIndex = parseInt(chapterSelect.value);
      if (isNaN(bookIndex) || isNaN(chapterIndex) || !CURRENT_BIBLE) return;
      const totalChapters = CURRENT_BIBLE.books[bookIndex].chapters.length;
      let newChapterIndex = chapterIndex + direction;
      if (newChapterIndex < 0) {
        let newBookIndex = bookIndex - 1;
        if (newBookIndex < 0) return;
        bookSelect.value = newBookIndex;
        loadChapters();
        const newTotal = CURRENT_BIBLE.books[newBookIndex].chapters.length;
        chapterSelect.value = newTotal - 1;
      } else if (newChapterIndex >= totalChapters) {
        let newBookIndex = bookIndex + 1;
        if (newBookIndex >= CURRENT_BIBLE.books.length) return;
        bookSelect.value = newBookIndex;
        loadChapters();
        chapterSelect.value = 0;
      } else {
        chapterSelect.value = newChapterIndex;
      }
      loadVerses();
    }

    // === CORE APP FUNCTIONS (theme, calendar, etc.) ===
    let currentDayIndex = null;
    let currentView = 'today';
    function isDarkMode() { return document.body.classList.contains('dark-mode'); }
    function setTheme(dark) {
      if (dark) {
        document.body.classList.add('dark-mode');
        localStorage.setItem('theme', 'dark');
        document.getElementById('theme-toggle').innerHTML = '<i class="fas fa-sun"></i>';
      } else {
        document.body.classList.remove('dark-mode');
        localStorage.setItem('theme', 'light');
        document.getElementById('theme-toggle').innerHTML = '<i class="fas fa-moon"></i>';
      }
    }
    function toggleTheme() { setTheme(!isDarkMode()); }
    function applySavedTheme() {
      const saved = localStorage.getItem('theme');
      if (saved === 'dark') setTheme(true);
      else if (saved === 'light') setTheme(false);
      else if (window.matchMedia('(prefers-color-scheme: dark)').matches) setTheme(true);
      else setTheme(false);
    }
    function loadProgress() {
      const saved = localStorage.getItem('bibleProgress');
      return saved ? JSON.parse(saved) : {};
    }
    function saveProgress(progress) {
      localStorage.setItem('bibleProgress', JSON.stringify(progress));
    }
    function renderReadings(dayIndex) {
      if (dayIndex < 0 || dayIndex >= READING_PLAN_EN.length) return;
      const now = new Date();
      const year = now.getFullYear();
      const targetDate = new Date(year, 0, 1);
      targetDate.setDate(targetDate.getDate() + dayIndex);
      document.getElementById('today-date').textContent = targetDate.toLocaleDateString('en-US', {
        weekday: 'short', month: 'short', day: 'numeric'
      });
      const en = READING_PLAN_EN[dayIndex];
      const ta = READING_PLAN_TA[dayIndex];
      const render = (id, enRefs, taRefs) => {
        document.getElementById(id).innerHTML = enRefs.map((enRef, i) => {
          const taRef = taRefs[i] || enRef;
          return `<div class="verse-item" onclick="openBibleReference('${enRef}')">
                    <div class="ref-en">${enRef}</div>
                    <div class="ref-ta">${taRef}</div>
                  </div>`;
        }).join('');
      };
      render('morning-list', en.morning, ta.morning);
      render('evening-list', en.evening, ta.evening);
      currentDayIndex = dayIndex;
      const startOfYear = new Date(now.getFullYear(), 0, 1);
      const currentDayOfYear = Math.floor((now - startOfYear) / 86400000);
      const isToday = (dayIndex === currentDayOfYear && now.getFullYear() === year);
      document.getElementById('today-btn').style.display = isToday ? 'none' : 'flex';
    }
    function goToDay(offset) {
      const now = new Date();
      const startOfYear = new Date(now.getFullYear(), 0, 1);
      const dayOfYear = Math.floor((now - startOfYear) / 86400000);
      let target = offset === 0 ? dayOfYear : (currentDayIndex !== null ? currentDayIndex + offset : dayOfYear + offset);
      target = Math.max(0, Math.min(READING_PLAN_EN.length - 1, target));
      renderReadings(target);
      if (currentView !== 'today') showTab('today');
    }
    function goToToday() {
      const now = new Date();
      const startOfYear = new Date(now.getFullYear(), 0, 1);
      const dayOfYear = Math.floor((now - startOfYear) / 86400000);
      renderReadings(Math.min(READING_PLAN_EN.length - 1, dayOfYear));
      if (currentView !== 'today') showTab('today');
    }
    function markAsRead() {
      if (currentDayIndex === null) return;
      const progress = loadProgress();
      progress[currentDayIndex] = true;
      saveProgress(progress);
      const btn = document.querySelector('.progress-btn');
      const original = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-check"></i> Done';
      setTimeout(() => { btn.innerHTML = original; }, 1000);
    }
    function showTab(view) {
      currentView = view;
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-btn')[['today','calendar','bible'].indexOf(view)].classList.add('active');
      document.getElementById('today-view').style.display = view === 'today' ? 'flex' : 'none';
      document.getElementById('calendar-view').style.display = view === 'calendar' ? 'block' : 'none';
      document.getElementById('bible-view').style.display = view === 'bible' ? 'block' : 'none';
      if (view === 'calendar') {
        renderFullCalendar();
      } else if (view === 'today') {
        // Always re-render readings when switching to today view to ensure date is visible
        if (currentDayIndex !== null) {
          renderReadings(currentDayIndex);
        } else {
          // If no current day index, calculate today's index
          const now = new Date();
          const startOfYear = new Date(now.getFullYear(), 0, 1);
          const dayOfYear = Math.floor((now - startOfYear) / 86400000);
          renderReadings(Math.min(READING_PLAN_EN.length - 1, dayOfYear));
        }
      } else if (view === 'bible') {
        // When switching to Bible tab, ensure last read position is loaded
        const bookSelect = document.getElementById('book-select');
        const chapterSelect = document.getElementById('chapter-select');
        if (bookSelect && bookSelect.value !== '' && chapterSelect && chapterSelect.value !== '') {
          // Reload verses if already has selection
          loadVerses();
        } else if (CURRENT_BIBLE) {
          // Load last position or default
          const lastPos = loadLastReadPosition();
          if (bookSelect) {
            bookSelect.value = lastPos.bookIndex;
            loadChapters(true);
          }
        }
      }
    }
    function renderFullCalendar() {
      const container = document.getElementById('calendar-view');
      container.innerHTML = '';
      const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      const progress = loadProgress();
      const year = new Date().getFullYear();
      const currentMonth = new Date().getMonth();
      for (let month = 0; month < 12; month++) {
        const monthDiv = document.createElement('div');
        monthDiv.style.marginBottom = '16px';
        monthDiv.id = `calendar-month-${month}`;
        const monthHeader = document.createElement('div');
        monthHeader.textContent = months[month];
        monthHeader.style.color = 'var(--accent)';
        monthHeader.style.fontSize = '0.95rem';
        monthHeader.style.marginBottom = '8px';
        monthDiv.appendChild(monthHeader);
        const grid = document.createElement('div');
        grid.style.display = 'grid';
        grid.style.gridTemplateColumns = 'repeat(7, 1fr)';
        grid.style.gap = '2px';
        grid.style.fontSize = '0.75rem';
        const firstDay = new Date(year, month, 1);
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const startDay = firstDay.getDay();
        const prevMonthDays = new Date(year, month, 0).getDate();
        for (let i = startDay - 1; i >= 0; i--) {
          const dayEl = document.createElement('div');
          dayEl.textContent = prevMonthDays - i;
          dayEl.style.color = '#888';
          dayEl.style.opacity = '0.4';
          dayEl.style.textAlign = 'center';
          grid.appendChild(dayEl);
        }
        const today = new Date();
        const isCurrentYear = (today.getFullYear() === year);
        const isCurrentMonth = (isCurrentYear && today.getMonth() === month);
        const todayDate = today.getDate();
        for (let day = 1; day <= daysInMonth; day++) {
          const date = new Date(year, month, day);
          const dayOfYear = Math.floor((date - new Date(year, 0, 1)) / 86400000);
          const isToday = isCurrentMonth && day === todayDate;
          const isCompleted = progress[dayOfYear] === true;
          const isFuture = dayOfYear >= READING_PLAN_EN.length;
          const dayEl = document.createElement('div');
          dayEl.textContent = day;
          dayEl.style.textAlign = 'center';
          dayEl.style.padding = '4px 0';
          dayEl.style.borderRadius = '4px';
          if (isFuture) {
            dayEl.style.color = '#888';
            dayEl.style.opacity = '0.4';
          } else {
            if (isCompleted) {
              dayEl.style.background = 'var(--success)';
              dayEl.style.color = 'white';
            }
            if (isToday && !isCompleted) {
              dayEl.style.background = 'var(--accent)';
              dayEl.style.color = 'white';
            }
            if (!isCompleted && !isToday) {
              dayEl.style.cursor = 'pointer';
              dayEl.onclick = () => {
                renderReadings(dayOfYear);
                showTab('today');
              };
            }
          }
          grid.appendChild(dayEl);
        }
        const totalCells = grid.children.length;
        const remaining = 42 - totalCells;
        for (let i = 1; i <= remaining; i++) {
          const dayEl = document.createElement('div');
          dayEl.textContent = i;
          dayEl.style.color = '#888';
          dayEl.style.opacity = '0.4';
          dayEl.style.textAlign = 'center';
          grid.appendChild(dayEl);
        }
        monthDiv.appendChild(grid);
        container.appendChild(monthDiv);
      }
      
      // Scroll to current month after a short delay to ensure rendering is complete
      setTimeout(() => {
        const currentMonthElement = document.getElementById(`calendar-month-${currentMonth}`);
        const calendarView = document.getElementById('calendar-view');
        if (currentMonthElement && calendarView) {
          // Calculate position accounting for sticky header
          const elementTop = currentMonthElement.offsetTop;
          const scrollPosition = elementTop - 120; // Account for title bar (60px) + tabs (60px) + padding
          calendarView.scrollTop = Math.max(0, scrollPosition);
        }
      }, 150);
    }
    async function shareReadingsAsImage() {
      if (currentDayIndex === null) return;
      if (!window.html2canvas) {
        await new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = 'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
          script.onload = resolve;
          script.onerror = reject;
          document.head.appendChild(script);
        });
      }
      const en = READING_PLAN_EN[currentDayIndex];
      const ta = READING_PLAN_TA[currentDayIndex].morning.map(s => s.replace(/<[^>]*>/g, ''));
      const eveningTa = READING_PLAN_TA[currentDayIndex].evening.map(s => s.replace(/<[^>]*>/g, ''));
      const dateStr = document.getElementById('today-date').textContent;
      const card = document.createElement('div');
      card.style.cssText = `
        position: fixed;
        left: -9999px;
        top: -9999px;
        width: 380px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 30px;
        border-radius: 20px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        color: #fff;
        line-height: 1.6;
        box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      `;
      card.innerHTML = `
        <div style="text-align:center; margin-bottom:20px;">
          <div style="font-size:2.5rem; color:#ffd700; margin-bottom:8px;">
            <i class="fas fa-book-open"></i>
          </div>
          <div style="font-size:1.2rem; font-weight:700; margin-bottom:4px;">One Year Bible</div>
          <div style="font-size:0.95rem; opacity:0.9;">${dateStr}</div>
        </div>
        <div style="margin-bottom:24px; background:rgba(255,255,255,0.15); border-radius:12px; padding:20px; backdrop-filter:blur(10px);">
          <div style="text-align:center; margin-bottom:12px;">
            <i class="fas fa-sun" style="font-size:3rem; color:#ffd700; text-shadow: 0 2px 8px rgba(255,215,0,0.5);"></i>
          </div>
          <div style="text-align:center; font-size:1.15rem; font-weight:500; margin-bottom:8px;">
            ${en.morning.join(', ')}
          </div>
          <div style="text-align:center; font-size:1.1rem; font-family:'Noto Sans Tamil','Latha',sans-serif; opacity:0.95; line-height:1.5;">
            ${ta.join(', ')}
          </div>
        </div>
        <div style="background:rgba(255,255,255,0.15); border-radius:12px; padding:20px; backdrop-filter:blur(10px);">
          <div style="text-align:center; margin-bottom:12px;">
            <i class="fas fa-moon" style="font-size:3rem; color:#e0e7ff; text-shadow: 0 2px 8px rgba(224,231,255,0.5);"></i>
          </div>
          <div style="text-align:center; font-size:1.15rem; font-weight:500; margin-bottom:8px;">
            ${en.evening.join(', ')}
          </div>
          <div style="text-align:center; font-size:1.1rem; font-family:'Noto Sans Tamil','Latha',sans-serif; opacity:0.95; line-height:1.5;">
            ${eveningTa.join(', ')}
          </div>
        </div>
        <div style="margin-top:20px; text-align:center; font-size:0.85rem; opacity:0.8;">
          тАФ New Jerusalem Church
        </div>
      `;
      document.body.appendChild(card);
      const canvas = await html2canvas(card, {
        scale: 2,
        backgroundColor: null,
        logging: false
      });
      document.body.removeChild(card);
      return new Promise((resolve) => {
        canvas.toBlob(blob => resolve(blob), 'image/png');
      });
    }
    async function shareReadings() {
      try {
        const blob = await shareReadingsAsImage();
        if (!blob) throw new Error('Image creation failed');
        const file = new File([blob], 'NJC_Bible_Reading.png', { type: 'image/png' });
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
          await navigator.share({
            title: 'TodayтАЩs Bible Reading',
            text: 'ЁЯУЦ My daily Bible reading from New Jerusalem Church',
            files: [file]
          });
        } else {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'NJC_Bible_Reading.png';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }
      } catch (err) {
        console.error('Share failed:', err);
      }
    }

    // === NAV BUTTONS SHOW/HIDE ===
    let navHideTimeout = null;
    let touchStartX = 0;
    let touchStartY = 0;
    let isTouching = false;
    
    function showNavButtons() {
      const titleBar = document.querySelector('.title-bar');
      if (titleBar) {
        titleBar.classList.add('show-nav');
        
        // Clear existing timeout
        if (navHideTimeout) {
          clearTimeout(navHideTimeout);
        }
        
        // Auto-hide after 3 seconds
        navHideTimeout = setTimeout(() => {
          hideNavButtons();
        }, 3000);
      }
    }
    
    function hideNavButtons() {
      const titleBar = document.querySelector('.title-bar');
      if (titleBar && !isTouching) {
        titleBar.classList.remove('show-nav');
      }
    }
    
    // Track touch state and show nav buttons
    document.addEventListener('touchstart', (e) => {
      isTouching = true;
      if (e.touches.length > 0) {
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
      }
      showNavButtons();
    }, { passive: true });
    
    // Show on swipe (detect swipe gesture)
    document.addEventListener('touchmove', (e) => {
      if (e.touches.length > 0 && touchStartX > 0) {
        const touchEndX = e.touches[0].clientX;
        const touchEndY = e.touches[0].clientY;
        const deltaX = Math.abs(touchEndX - touchStartX);
        const deltaY = Math.abs(touchEndY - touchStartY);
        
        // If significant movement (swipe), show nav buttons
        if (deltaX > 30 || deltaY > 30) {
          showNavButtons();
        }
      }
    }, { passive: true });
    
    // Show on tap/touch end - any tap on screen shows nav buttons
    document.addEventListener('touchend', (e) => {
      isTouching = false;
      // Show nav buttons on any tap
      showNavButtons();
      // Reset touch position
      touchStartX = 0;
      touchStartY = 0;
    }, { passive: true });
    
    // Show on click (for desktop) - any click shows nav buttons
    document.addEventListener('click', (e) => {
      // Don't show if clicking on nav buttons themselves (they stay visible)
      if (!e.target.closest('.nav-btn')) {
        showNavButtons();
      }
    }, { passive: true });

    // === INIT ===
    window.addEventListener('load', () => {
      applySavedTheme();
      loadAppData();
      // Initially hide nav buttons - ensure they start hidden
      const titleBar = document.querySelector('.title-bar');
      if (titleBar) {
        titleBar.classList.remove('show-nav');
      }
    });
    
    // Also ensure hidden on DOMContentLoaded
    document.addEventListener('DOMContentLoaded', () => {
      const titleBar = document.querySelector('.title-bar');
      if (titleBar) {
        titleBar.classList.remove('show-nav');
      }
    });
  </script>
</body>
</html>
